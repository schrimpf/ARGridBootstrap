<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Paul Schrimpf">
  <meta name="dcterms.date" content="2019-10-13">
  <title>Coding for Performance</title>

<!-- TODO check if math works with plotly  -->
<!-- Need to load plotly before Mathjax or pandoc equations don't work -->


<script type="text/javascript">
  var fileref=document.createElement('script')
  fileref.setAttribute("type","text/javascript")
  fileref.setAttribute("src", "http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")
  document.getElementsByTagName("head")[0].appendChild(fileref)
</script>

  <style type="text/css">
  @font-face {
    font-style: normal;
    font-weight: 300;
  }
  @font-face {
    font-style: normal;
    font-weight: 400;
  }
  @font-face {
    font-style: normal;
    font-weight: 600;
  }
  html {
    font-family: sans-serif; /* 1 */
    -ms-text-size-adjust: 100%; /* 2 */
    -webkit-text-size-adjust: 100%; /* 2 */
  }
  body {
    margin: 0;
  }
  article,
  aside,
  details,
  figcaption,
  figure,
  footer,
  header,
  hgroup,
  main,
  menu,
  nav,
  section,
  summary {
    display: block;
  }
  audio,
  canvas,
  progress,
  video {
    display: inline-block; /* 1 */
    vertical-align: baseline; /* 2 */
  }
  audio:not([controls]) {
    display: none;
    height: 0;
  }
  [hidden],
  template {
    display: none;
  }
  a:active,
  a:hover {
    outline: 0;
  }
  abbr[title] {
    border-bottom: 1px dotted;
  }
  b,
  strong {
    font-weight: bold;
  }
  dfn {
    font-style: italic;
  }
  h1 {
    font-size: 2em;
    margin: 0.67em 0;
  }
  mark {
    background: #ff0;
    color: #000;
  }
  small {
    font-size: 80%;
  }
  sub,
  sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
  }
  sup {
    top: -0.5em;
  }
  sub {
    bottom: -0.25em;
  }
  img {
    border: 0;
  }
  svg:not(:root) {
    overflow: hidden;
  }
  figure {
    margin: 1em 40px;
  }
  hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
  }
  pre {
    overflow: auto;
  }
  code,
  kbd,
  pre,
  samp {
    font-family: monospace, monospace;
    font-size: 1em;
  }
  button,
  input,
  optgroup,
  select,
  textarea {
    color: inherit; /* 1 */
    font: inherit; /* 2 */
    margin: 0; /* 3 */
  }
  button {
    overflow: visible;
  }
  button,
  select {
    text-transform: none;
  }
  button,
  html input[type="button"], /* 1 */
  input[type="reset"],
  input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
  }
  button[disabled],
  html input[disabled] {
    cursor: default;
  }
  button::-moz-focus-inner,
  input::-moz-focus-inner {
    border: 0;
    padding: 0;
  }
  input {
    line-height: normal;
  }
  input[type="checkbox"],
  input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
  }
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    height: auto;
  }
  input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
  }
  input[type="search"]::-webkit-search-cancel-button,
  input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
  }
  fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
  }
  legend {
    border: 0; /* 1 */
    padding: 0; /* 2 */
  }
  textarea {
    overflow: auto;
  }
  optgroup {
    font-weight: bold;
  }
  table {
    font-family: monospace, monospace;
    font-size : 0.8em;
    border-collapse: collapse;
    border-spacing: 0;
  }
  td,
  th {
    padding: 0;
  }
  thead th {
      border-bottom: 1px solid black;
      background-color: white;
  }
  tr:nth-child(odd){
    background-color: rgb(248,248,248);
  }
  
  /*
  * Skeleton V2.0.4
  * Copyright 2014, Dave Gamache
  * www.getskeleton.com
  * Free to use under the MIT license.
  * http://www.opensource.org/licenses/mit-license.php
  * 12/29/2014
  */
  .container {
    position: relative;
    width: 100%;
    max-width: 960px;
    margin: 0 auto;
    padding: 0 20px;
    box-sizing: border-box; }
  .column,
  .columns {
    width: 100%;
    float: left;
    box-sizing: border-box; }
  @media (min-width: 400px) {
    .container {
      width: 85%;
      padding: 0; }
  }
  @media (min-width: 550px) {
    .container {
      width: 80%; }
    .column,
    .columns {
      margin-left: 4%; }
    .column:first-child,
    .columns:first-child {
      margin-left: 0; }
  
    .one.column,
    .one.columns                    { width: 4.66666666667%; }
    .two.columns                    { width: 13.3333333333%; }
    .three.columns                  { width: 22%;            }
    .four.columns                   { width: 30.6666666667%; }
    .five.columns                   { width: 39.3333333333%; }
    .six.columns                    { width: 48%;            }
    .seven.columns                  { width: 56.6666666667%; }
    .eight.columns                  { width: 65.3333333333%; }
    .nine.columns                   { width: 74.0%;          }
    .ten.columns                    { width: 82.6666666667%; }
    .eleven.columns                 { width: 91.3333333333%; }
    .twelve.columns                 { width: 100%; margin-left: 0; }
  
    .one-third.column               { width: 30.6666666667%; }
    .two-thirds.column              { width: 65.3333333333%; }
  
    .one-half.column                { width: 48%; }
  
    /* Offsets */
    .offset-by-one.column,
    .offset-by-one.columns          { margin-left: 8.66666666667%; }
    .offset-by-two.column,
    .offset-by-two.columns          { margin-left: 17.3333333333%; }
    .offset-by-three.column,
    .offset-by-three.columns        { margin-left: 26%;            }
    .offset-by-four.column,
    .offset-by-four.columns         { margin-left: 34.6666666667%; }
    .offset-by-five.column,
    .offset-by-five.columns         { margin-left: 43.3333333333%; }
    .offset-by-six.column,
    .offset-by-six.columns          { margin-left: 52%;            }
    .offset-by-seven.column,
    .offset-by-seven.columns        { margin-left: 60.6666666667%; }
    .offset-by-eight.column,
    .offset-by-eight.columns        { margin-left: 69.3333333333%; }
    .offset-by-nine.column,
    .offset-by-nine.columns         { margin-left: 78.0%;          }
    .offset-by-ten.column,
    .offset-by-ten.columns          { margin-left: 86.6666666667%; }
    .offset-by-eleven.column,
    .offset-by-eleven.columns       { margin-left: 95.3333333333%; }
  
    .offset-by-one-third.column,
    .offset-by-one-third.columns    { margin-left: 34.6666666667%; }
    .offset-by-two-thirds.column,
    .offset-by-two-thirds.columns   { margin-left: 69.3333333333%; }
  
    .offset-by-one-half.column,
    .offset-by-one-half.columns     { margin-left: 52%; }
  
  }
  html {
    font-size: 62.5%; }
  body {
    font-size: 1.5em; /* currently ems cause chrome bug misinterpreting rems on body element */
    line-height: 1.6;
    font-weight: 400;
    font-family: "Raleway", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
    color: #222; }
  h1, h2, h3, h4, h5, h6 {
    margin-top: 0;
    margin-bottom: 2rem;
    font-weight: 300; }
  h1 { font-size: 3.6rem; line-height: 1.2;  letter-spacing: -.1rem;}
  h2 { font-size: 3.4rem; line-height: 1.25; letter-spacing: -.1rem; }
  h3 { font-size: 3.2rem; line-height: 1.3;  letter-spacing: -.1rem; }
  h4 { font-size: 2.8rem; line-height: 1.35; letter-spacing: -.08rem; }
  h5 { font-size: 2.4rem; line-height: 1.5;  letter-spacing: -.05rem; }
  h6 { font-size: 1.5rem; line-height: 1.6;  letter-spacing: 0; }
  
  p {
    margin-top: 0; }
  a {
    color: #1EAEDB; }
  a:hover {
    color: #0FA0CE; }
  .button,
  button,
  input[type="submit"],
  input[type="reset"],
  input[type="button"] {
    display: inline-block;
    height: 38px;
    padding: 0 30px;
    color: #555;
    text-align: center;
    font-size: 11px;
    font-weight: 600;
    line-height: 38px;
    letter-spacing: .1rem;
    text-transform: uppercase;
    text-decoration: none;
    white-space: nowrap;
    background-color: transparent;
    border-radius: 4px;
    border: 1px solid #bbb;
    cursor: pointer;
    box-sizing: border-box; }
  .button:hover,
  button:hover,
  input[type="submit"]:hover,
  input[type="reset"]:hover,
  input[type="button"]:hover,
  .button:focus,
  button:focus,
  input[type="submit"]:focus,
  input[type="reset"]:focus,
  input[type="button"]:focus {
    color: #333;
    border-color: #888;
    outline: 0; }
  .button.button-primary,
  button.button-primary,
  input[type="submit"].button-primary,
  input[type="reset"].button-primary,
  input[type="button"].button-primary {
    color: #FFF;
    background-color: #33C3F0;
    border-color: #33C3F0; }
  .button.button-primary:hover,
  button.button-primary:hover,
  input[type="submit"].button-primary:hover,
  input[type="reset"].button-primary:hover,
  input[type="button"].button-primary:hover,
  .button.button-primary:focus,
  button.button-primary:focus,
  input[type="submit"].button-primary:focus,
  input[type="reset"].button-primary:focus,
  input[type="button"].button-primary:focus {
    color: #FFF;
    background-color: #1EAEDB;
    border-color: #1EAEDB; }
  input[type="email"],
  input[type="number"],
  input[type="search"],
  input[type="text"],
  input[type="tel"],
  input[type="url"],
  input[type="password"],
  textarea,
  select {
    height: 38px;
    padding: 6px 10px; /* The 6px vertically centers text on FF, ignored by Webkit */
    background-color: #fff;
    border: 1px solid #D1D1D1;
    border-radius: 4px;
    box-shadow: none;
    box-sizing: border-box; }
  /* Removes awkward default styles on some inputs for iOS */
  input[type="email"],
  input[type="number"],
  input[type="search"],
  input[type="text"],
  input[type="tel"],
  input[type="url"],
  input[type="password"],
  textarea {
    -webkit-appearance: none;
       -moz-appearance: none;
            appearance: none; }
  textarea {
    min-height: 65px;
    padding-top: 6px;
    padding-bottom: 6px; }
  input[type="email"]:focus,
  input[type="number"]:focus,
  input[type="search"]:focus,
  input[type="text"]:focus,
  input[type="tel"]:focus,
  input[type="url"]:focus,
  input[type="password"]:focus,
  textarea:focus,
  select:focus {
    border: 1px solid #33C3F0;
    outline: 0; }
  label,
  legend {
    display: block;
    margin-bottom: .5rem;
    font-weight: 600; }
  fieldset {
    padding: 0;
    border-width: 0; }
  input[type="checkbox"],
  input[type="radio"] {
    display: inline; }
  label > .label-body {
    display: inline-block;
    margin-left: .5rem;
    font-weight: normal; }
  ul {
    list-style: circle inside; }
  ol {
    list-style: decimal inside; }
  ol, ul {
    padding-left: 0;
    margin-top: 0; }
  ul ul,
  ul ol,
  ol ol,
  ol ul {
    margin: 1.5rem 0 1.5rem 3rem;
    font-size: 90%; }
  li {
    margin-bottom: 1rem; }
  th,
  td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #E1E1E1; }
  th:first-child,
  td:first-child {
    padding-left: 0; }
  th:last-child,
  td:last-child {
    padding-right: 0; }
  button,
  .button {
    margin-bottom: 1rem; }
  input,
  textarea,
  select,
  fieldset {
    margin-bottom: 1.5rem; }
  pre,
  blockquote,
  dl,
  figure,
  table,
  p,
  ul,
  ol,
  form {
    margin-bottom: 2.5rem; }
  .u-full-width {
    width: 100%;
    box-sizing: border-box; }
  .u-max-full-width {
    max-width: 100%;
    box-sizing: border-box; }
  .u-pull-right {
    float: right; }
  .u-pull-left {
    float: left; }
  hr {
    margin-top: 3rem;
    margin-bottom: 3.5rem;
    border-width: 0;
    border-top: 1px solid #E1E1E1; }
  .container:after,
  .row:after,
  .u-cf {
    content: "";
    display: table;
    clear: both; }
  
  pre {
    display: block;
    padding: 9.5px;
    margin: 0 0 10px;
    font-size: 13px;
    line-height: 1.42857143;
    color: #333;
    word-break: break-all;
    word-wrap: break-word;
    background-color: #ffffff;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  
  pre.sourceCode.julia {
    display: block;
    padding: 9.5px;
    margin: 0 0 10px;
    font-size: 12px;
    line-height: 1.42857143;
    color: #333;
    word-break: break-all;
    word-wrap: break-word;
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  
  pre.julia-error {
    color : red
  }
  
  code,
  kbd,
  pre,
  samp {
    font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
  }
  code {
    background-color: #ffffff;
    border-radius: 4px;
  }
  
  code.sourceCode.julia {
    background-color: #f5f5f5;
    border-radius: 4px;
  }
  
  
  @media (min-width: 400px) {}
  @media (min-width: 550px) {}
  @media (min-width: 750px) {}
  @media (min-width: 1000px) {}
  @media (min-width: 1200px) {}
  
  h1.title {margin-top : 20px}
  img {max-width : 100%}
  </style>


<style>
pre.hljl {
    border: 1px solid #ccc;
    margin: 5px;
    padding: 5px;
    overflow-x: auto;
    color: rgb(68,68,68); background-color: rgb(251,251,251); }
pre.hljl > span.hljl-t { }
pre.hljl > span.hljl-w { }
pre.hljl > span.hljl-e { }
pre.hljl > span.hljl-eB { }
pre.hljl > span.hljl-o { }
pre.hljl > span.hljl-k { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kc { color: rgb(59,151,46); font-style: italic; }
pre.hljl > span.hljl-kd { color: rgb(214,102,97); font-style: italic; }
pre.hljl > span.hljl-kn { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kp { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kr { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kt { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-n { }
pre.hljl > span.hljl-na { }
pre.hljl > span.hljl-nb { }
pre.hljl > span.hljl-nbp { }
pre.hljl > span.hljl-nc { }
pre.hljl > span.hljl-ncB { }
pre.hljl > span.hljl-nd { color: rgb(214,102,97); }
pre.hljl > span.hljl-ne { }
pre.hljl > span.hljl-neB { }
pre.hljl > span.hljl-nf { color: rgb(66,102,213); }
pre.hljl > span.hljl-nfm { color: rgb(66,102,213); }
pre.hljl > span.hljl-np { }
pre.hljl > span.hljl-nl { }
pre.hljl > span.hljl-nn { }
pre.hljl > span.hljl-no { }
pre.hljl > span.hljl-nt { }
pre.hljl > span.hljl-nv { }
pre.hljl > span.hljl-nvc { }
pre.hljl > span.hljl-nvg { }
pre.hljl > span.hljl-nvi { }
pre.hljl > span.hljl-nvm { }
pre.hljl > span.hljl-l { }
pre.hljl > span.hljl-ld { color: rgb(148,91,176); font-style: italic; }
pre.hljl > span.hljl-s { color: rgb(201,61,57); }
pre.hljl > span.hljl-sa { color: rgb(201,61,57); }
pre.hljl > span.hljl-sb { color: rgb(201,61,57); }
pre.hljl > span.hljl-sc { color: rgb(201,61,57); }
pre.hljl > span.hljl-sd { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdB { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdC { color: rgb(201,61,57); }
pre.hljl > span.hljl-se { color: rgb(59,151,46); }
pre.hljl > span.hljl-sh { color: rgb(201,61,57); }
pre.hljl > span.hljl-si { }
pre.hljl > span.hljl-so { color: rgb(201,61,57); }
pre.hljl > span.hljl-sr { color: rgb(201,61,57); }
pre.hljl > span.hljl-ss { color: rgb(201,61,57); }
pre.hljl > span.hljl-ssB { color: rgb(201,61,57); }
pre.hljl > span.hljl-nB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nbB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nfB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nh { color: rgb(59,151,46); }
pre.hljl > span.hljl-ni { color: rgb(59,151,46); }
pre.hljl > span.hljl-nil { color: rgb(59,151,46); }
pre.hljl > span.hljl-noB { color: rgb(59,151,46); }
pre.hljl > span.hljl-oB { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-ow { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-p { }
pre.hljl > span.hljl-c { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-ch { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cm { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cp { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cpB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cs { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-csB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-g { }
pre.hljl > span.hljl-gd { }
pre.hljl > span.hljl-ge { }
pre.hljl > span.hljl-geB { }
pre.hljl > span.hljl-gh { }
pre.hljl > span.hljl-gi { }
pre.hljl > span.hljl-go { }
pre.hljl > span.hljl-gp { }
pre.hljl > span.hljl-gs { }
pre.hljl > span.hljl-gsB { }
pre.hljl > span.hljl-gt { }
</style>



</head>
<body>
<div class="container">
        <div class="row">
            <div class="col-md-12 twelve columns">



<h1 class="title">Coding for Performance</h1>

<p><strong>Author:</strong>
Paul Schrimpf
<br />

<strong>Date: </strong>2019-10-13
</p>

<nav id="TOC">
<ul>
<li><a href="#introudction">Introudction</a></li>
<li><a href="#grid-bootstrap">Grid bootstrap</a><ul>
<li><a href="#improving-performance">Improving performance</a></li>
<li><a href="#fastest-version">Fastest version</a></li>
</ul></li>
<li><a href="#multi-threading">Multi-threading</a></li>
<li><a href="#gpu">GPU</a><ul>
<li><a href="#array-interface">Array interface</a></li>
<li><a href="#cudanative">CUDAnative</a></li>
<li><a href="#gpu-grid-bootstrap">GPU grid bootstrap</a></li>
</ul></li>
</ul>
</nav>
<p><a href="http://creativecommons.org/licenses/by-sa/4.0/"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAAAfCAYAAABjyArgAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAdnJLH8AAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAABh9JREFUaN7tWltPG0cU9nOlIN55KFKRApWoSKu06kuClP4A+gPSUvU1alFbVYpEFYpIq6hVkUVF00rgRnkrFwPGgC/YBtv4srbXhpBXIvGQviF+wYm+s55ldlnbu951WjmMdOT1zOwZ+5sz37ns+oiox+fz0ZV4L0T4qH8JRzdpO75FkcQOxfdilEgnaC+bonQ+TQfFLOVLOSqUC6RUilRSFSpVS5qoCilqkYrlAs/B3Ew+zfcm0wnWFUlEWDfWCO1s0Pr2Gq2Fg7S6uUIroWWW5Y0lWlr/p2tEAvoC3GgyQrv7cUplkpTO7TNYhXKeAazUylQ9Uqn2rEqHx4d09FwTXNee1XgMcxRV4XtwL3SksknWCd1mkIPhVR1kANylIPuM4GZTbIE5JcfWCtAA6szDGbrzyR261nPt0lFAH8ZmfprhuZXDCm8KLDpTyLA17+7vGkDe2Fmnta2gBnJopaUV35+8T0NDQ5fWRh/G3ILRCf06wKAFGVwAU6oqbJX+OT/19fXZ5h3M9f/u53tBIbDmrA5yXKeLzUiINrY1kJtZ8dzjORocGtT1j46O0sTEBAuuRT/mYK5TEDqpXwcYPAlauAC3xJY49umYAbze3l4aHx+nqakpSiaTLLhGH8bkubg3k0tTuaaBDEsGXWicvENbsbCRKiysOPB0kXp6ejR9Y2N0cnJC5oY+jGEO5joBodP6dYDh0MCXoAVYrhlcgAcgz87OqFkLBAIGoLHrABkbho3DGnB8sVSUdna3NaqwsGLxA4VlYQPlJnlpw9piTbsAWOk/PT2lfC7Hgms3+nWAcXzhlMC5ONoyuCMjI5Y726hhE3CPbMnQCU7GGhdUIVnx1hoFN1cNNAHeE5b1/Pi4JcBowtLscKaV/qdPntA7b/cbJBqJtKXfAHCaqSHPDg2cK4PbymrtgAxOhuNjqsinKZnRrJi5OKpxsaAJAbBwOE42F3OFY2r15836YbEA9PZHH9OXn39B33/7nQ6yf3bWsX4DwGy9apGpQTg0HHVVVandBpAFXUAndCOEE1Yc39OsWI4oZJoQDsfccJzFxpmpA004Jjt/Xug/Pz+nwPxfDOZvP/+i61pcWOC+G8PvOdZvABj8WK6VORQTPx6c67YJ3oIghMMJEVycqIdtMk2YAYYnNzeLbMnQcI9dgIV+ADwwMMBgDg4OGvhYWPG/L1860m8AGBmaeqRyLCusV6YGRAvgH+weRAbfPDZbP06iCSuGbnAxMr5LNBEJadGExMOvE2C0cDhMw8PD/H+sAH5x8qJ9gOHccIRFEiEfPSxoFe8CzGAwaDkm3y+ONHQj4wMVZeshWywV42gCPCzCtf+CItDgzODkCvm83re8tKQD7IoiUE84PK7pP1y2QuGs+vv7meQBOK5x/MWYiDQAuBizogmk1SUDD8cM4ZoMcDMn18h63Tg5wbeQmR+nWd69fp2/P57/w52TQ+yLuoL44fIxacbJdvhaPgFYAzHxQfGgJcByGGUX4HbDNNEAqjlM++rePeZoV2Ha/xFgp4mG4Ea3iYZSVJgaIHL83Y5+xxQBx4fQDdcAVaYI85hbiuiqVLmZk2vmyOw4ObHzmpOr8lp2nJwMglyMwWZCP/TKyUy7xZ5O6r8UpokUGaGV+Zg3CtMAsug3j6HBouUwrSCFadFk4zCtq8qVItGQ02RzPOtlorFfTzRQuhSJRqOCT1cU3LMF61TZSR3A61S5qwCWiz2Lfy94X+yZ87NuFHuwlihZyoV3c7GnqwCGTD6Y1MuVdz+7awDZSdEHVm9ZrqwUafrh9Jv4dPniy8Q3X3MYVW2j4I4xzJEL7jc/vMnUgDgbG/iGPr43dvzwYJKTAYAsW3I7j4wAbrlaovk/592+X2CZZJjndGINt3p9Vp0Msqo99AQnO37oOSceeiquwTWDZ3XtBbh21/QEYEEX8mN7gNbqsT2eXPBje7wfUSl6RgutypVertGozuE5wJD3P7hBwY0gh3CIk1X9xZOa9OJJjfvkF0/WQkG6dfuWl68gdYwaGq3VcQuWBWA9+vURxVNx6dWpuuDVqUqRxzDHS2BflwW34viOA3wlLoSI3roConNvV74C8NfodpNElTgAAAAASUVORK5CYII=" /></a></p>
<p>This work is licensed under a <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a></p>
<h3 id="about-this-document" class="unnumbered">About this document</h3>
<p>This document was created using Weave.jl. The code is available in <a href="FIXME">on github</a>. The same document generates both static webpages and associated jupyter notebooks.</p>
<h1 id="introudction">Introudction</h1>
<p>Today we will look into some methods to improve the speed of our code. Although speed is sometimes important, never forget that speed should be low on your list of priorities when writing code. You should prioritize correctness and maintainability ahead of performance. Nonetheless, performance does matter for some problems.</p>
<h1 id="grid-bootstrap">Grid bootstrap</h1>
<p>As a motivating example we will look at the gridded bootstrap of <span class="citation" data-cites="hansen99">Hansen (1999)</span>. FIXME: DESCRIPTION. Gauss, Matlab, and R code implementing Hansen’s method is available on <a href="https://www.ssc.wisc.edu/~bhansen/progs/restat_99.html">his website</a>. The Julia code below is more or less a direct translation from Hansen’s R code. Since this is a translation from R of a translation from Gauss, this code will not necessarily follow best practices for Julia.</p>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    b_est_original(y)

Estimate AR(1) model with intercept and time trend

    y[t] = θ[0] + θ[1]t + θ[2]y[t-1] + e[t]

# Arguments
- `y`: vector 

# Returns 
- `θ`: estimated coefficients
- `se`: standard errors
- `e`: residuals 
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">b_est_original</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">x</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">[</span><span class="hljl-nf">ones</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)]]</span><span class="hljl-t">
  </span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">θ</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">x</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">x</span><span class="hljl-t"> </span><span class="hljl-oB">\</span><span class="hljl-t"> </span><span class="hljl-n">x</span><span class="hljl-oB">&#39;</span><span class="hljl-n">y</span><span class="hljl-t">
  </span><span class="hljl-n">e</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">x</span><span class="hljl-oB">*</span><span class="hljl-n">θ</span><span class="hljl-t">
  </span><span class="hljl-n">se</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">sqrt</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-nf">diag</span><span class="hljl-p">(</span><span class="hljl-nf">inv</span><span class="hljl-p">(</span><span class="hljl-n">x</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">x</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">e</span><span class="hljl-p">))</span><span class="hljl-oB">./</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">4</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">θ</span><span class="hljl-oB">=</span><span class="hljl-n">θ</span><span class="hljl-p">,</span><span class="hljl-n">se</span><span class="hljl-oB">=</span><span class="hljl-n">se</span><span class="hljl-p">,</span><span class="hljl-n">e</span><span class="hljl-oB">=</span><span class="hljl-n">e</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-k">end</span><span class="hljl-t">
</span><span class="hljl-s">&quot;&quot;&quot;
    ar1_original(y0, a, e, rindex=T-&gt;rand(1:length(e), T))

Simulate AR1 model by sampling errors from e with replacement. 
  
    y[t] = a*y[t-1] + ϵ[t]

# Arguments 
- `y0`: initial value for `y`
- `a`: AR parameter
- `e`: values of for error term. `ϵ = e[rindex(T)]]`
- `rindex` function that returns random index in 1:length(e)
  
# Returns 
- `y`: vector of length `T = length(e)`
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">ar1_original</span><span class="hljl-p">(</span><span class="hljl-n">y0</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">rindex</span><span class="hljl-oB">=</span><span class="hljl-n">T</span><span class="hljl-oB">-&gt;</span><span class="hljl-nf">rand</span><span class="hljl-p">(</span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">),</span><span class="hljl-n">T</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">Array</span><span class="hljl-p">{</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">)}(</span><span class="hljl-n">undef</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">T</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">y</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">abs</span><span class="hljl-p">(</span><span class="hljl-n">a</span><span class="hljl-p">)</span><span class="hljl-oB">&lt;</span><span class="hljl-ni">1</span><span class="hljl-t"> </span><span class="hljl-oB">?</span><span class="hljl-t"> </span><span class="hljl-n">y0</span><span class="hljl-t"> </span><span class="hljl-oB">:</span><span class="hljl-t"> </span><span class="hljl-nf">zero</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">y</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-n">et</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">[</span><span class="hljl-nf">rindex</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)]</span><span class="hljl-t">
  </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-t">
    </span><span class="hljl-n">y</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-oB">*</span><span class="hljl-n">y</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+</span><span class="hljl-t"> </span><span class="hljl-n">et</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> 
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">y</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    gridbootstrap(estimator, simulator, 
                  grid::AbstractVector, 
                  nboot=199)
  
Computes grid bootstrap estimates a single parameter model. 

For each α ∈ grid, repeatedly simulate data with parameter α and then compute an estimate. 
 

# Arguments
- `estimator` function of output of `simulator` that returns a
        2-tuple containing an estimate of α and its standard error.  
- `simulator` function that given `α` simulates data that can be used to estimate α
- `grid` grid of parameter values. For each value, `nboot`
        datasets will be simulated and estimates computed.  
- `nboot` 

# Returns
- `ba` hatα - α for each grid value and simulated dataset
- `t` t-stat  for each grid value and simulated dataset
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">gridbootstrap</span><span class="hljl-p">(</span><span class="hljl-n">estimator</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">simulator</span><span class="hljl-p">,</span><span class="hljl-t">
                       </span><span class="hljl-n">grid</span><span class="hljl-oB">::</span><span class="hljl-n">AbstractVector</span><span class="hljl-p">,</span><span class="hljl-t">
                       </span><span class="hljl-n">nboot</span><span class="hljl-oB">=</span><span class="hljl-ni">199</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">g</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">grid</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">bootq</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">g</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">ba</span><span class="hljl-t">    </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">g</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">bootse</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-n">g</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">ak</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-n">g</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-n">nboot</span><span class="hljl-t"> 
      </span><span class="hljl-p">(</span><span class="hljl-n">bootq</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">],</span><span class="hljl-t"> </span><span class="hljl-n">bootse</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">])</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">estimator</span><span class="hljl-p">(</span><span class="hljl-nf">simulator</span><span class="hljl-p">(</span><span class="hljl-n">grid</span><span class="hljl-p">[</span><span class="hljl-n">ak</span><span class="hljl-p">]))</span><span class="hljl-t">
      </span><span class="hljl-n">ba</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">bootq</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">grid</span><span class="hljl-p">[</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">ts</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">ba</span><span class="hljl-oB">./</span><span class="hljl-n">bootse</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-oB">=</span><span class="hljl-n">ba</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-oB">=</span><span class="hljl-n">ts</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<h2 id="improving-performance">Improving performance</h2>
<p>Now, let’s run this code and time it. Note that we are running this with only 50 grid points and 199 bootstrap replications. In real use, you would want more like 999 bootstrap replications or more, and perhaps more grid points.</p>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    gridbootstrap(estimator, simulator, 
                  grid::AbstractVector, 
                  nboot=199)
  
Computes grid bootstrap estimates a single parameter model. 

For each α ∈ grid, repeatedly simulate data with parameter α and then compute an estimate. 
 

# Arguments
- `estimator` function of output of `simulator` that returns a
        2-tuple containing an estimate of α and its standard error.  
- `simulator` function that given `α` simulates data that can be used to estimate α
- `grid` grid of parameter values. For each value, `nboot`
        datasets will be simulated and estimates computed.  
- `nboot` 

# Returns
- `ba` hatα - α for each grid value and simulated dataset
- `t` t-stat  for each grid value and simulated dataset
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">gridbootstrap</span><span class="hljl-p">(</span><span class="hljl-n">estimator</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">simulator</span><span class="hljl-p">,</span><span class="hljl-t">
                       </span><span class="hljl-n">grid</span><span class="hljl-oB">::</span><span class="hljl-n">AbstractVector</span><span class="hljl-p">,</span><span class="hljl-t">
                       </span><span class="hljl-n">nboot</span><span class="hljl-oB">=</span><span class="hljl-ni">199</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">g</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">grid</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">bootq</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">g</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">ba</span><span class="hljl-t">    </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">g</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">bootse</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-n">g</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">ak</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-n">g</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-n">nboot</span><span class="hljl-t"> 
      </span><span class="hljl-p">(</span><span class="hljl-n">bootq</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">],</span><span class="hljl-t"> </span><span class="hljl-n">bootse</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">])</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">estimator</span><span class="hljl-p">(</span><span class="hljl-nf">simulator</span><span class="hljl-p">(</span><span class="hljl-n">grid</span><span class="hljl-p">[</span><span class="hljl-n">ak</span><span class="hljl-p">]))</span><span class="hljl-t">
      </span><span class="hljl-n">ba</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">bootq</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">grid</span><span class="hljl-p">[</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">ts</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">ba</span><span class="hljl-oB">./</span><span class="hljl-n">bootse</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-oB">=</span><span class="hljl-n">ba</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-oB">=</span><span class="hljl-n">ts</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<p>To make code faster, we should begin by profiling.</p>
<pre class="hljl">
<span class="hljl-cs"># simulate some data</span><span class="hljl-t">
</span><span class="hljl-k">using</span><span class="hljl-t"> </span><span class="hljl-n">Random</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">BenchmarkTools</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">Profile</span><span class="hljl-t">
</span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">200</span><span class="hljl-t">
</span><span class="hljl-n">e</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">randn</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-n">y0</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">0</span><span class="hljl-t">
</span><span class="hljl-n">a</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nfB">0.9</span><span class="hljl-t">
</span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">ar1_original</span><span class="hljl-p">(</span><span class="hljl-n">y0</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-n">est</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">b_est_original</span><span class="hljl-p">(</span><span class="hljl-n">y</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-n">αgrid</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nfB">0.84</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-nfB">0.22</span><span class="hljl-oB">/</span><span class="hljl-ni">50</span><span class="hljl-p">)</span><span class="hljl-oB">:</span><span class="hljl-nfB">1.06</span><span class="hljl-t">
</span><span class="hljl-n">nboot</span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">199</span><span class="hljl-t">
</span><span class="hljl-nf">wrapper</span><span class="hljl-p">(</span><span class="hljl-n">b_est</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-k">function</span><span class="hljl-p">(</span><span class="hljl-n">x</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">out</span><span class="hljl-oB">=</span><span class="hljl-nf">b_est</span><span class="hljl-p">(</span><span class="hljl-n">x</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">out</span><span class="hljl-oB">.</span><span class="hljl-n">θ</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">],</span><span class="hljl-t"> </span><span class="hljl-n">out</span><span class="hljl-oB">.</span><span class="hljl-n">se</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">])</span><span class="hljl-t">
</span><span class="hljl-k">end</span><span class="hljl-t">
</span><span class="hljl-nd">@btime</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">t</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">gridbootstrap</span><span class="hljl-p">(</span><span class="hljl-nf">wrapper</span><span class="hljl-p">(</span><span class="hljl-n">b_est_original</span><span class="hljl-p">),</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-oB">-&gt;</span><span class="hljl-nf">ar1_original</span><span class="hljl-p">(</span><span class="hljl-n">y0</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">est</span><span class="hljl-oB">.</span><span class="hljl-n">e</span><span class="hljl-p">),</span><span class="hljl-t">
                             </span><span class="hljl-n">αgrid</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">nboot</span><span class="hljl-p">);</span>
</pre>
<p>4.017 s (365375 allocations: 222.07 MiB)</p>
<p>Profile.jl works very simply. Every 0.0001 seconds, the line of code being executed gets recorded. <code>Profile.print</code> shows the count of how many times each line of code got recorded. From the output (these numbers can vary quite a bit from run to run), we see there were 640 ticks in <code>gridbootstrap_original</code> (exact numbers will vary on each execution, but relative ones should be similar), and almost all of these occurred within <code>inv</code>. If we want the code to be faster, we should focus on these lines. Calling both <code>inv</code> and <code>\</code> is redundant; we should combine these computations.</p>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    b_est_mldivide(y)

  Estimate AR(1) model with intercept and time trend. 

    y[t] = θ[0] + θ[1]t + θ[2]y[t-1] + e[t]

# Arguments    
- `y`: vector 

# Returns
- `θ`: estimated coefficients
- `se`: standard errors
- `e`: residuals 
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">b_est_mldivide</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">x</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">[</span><span class="hljl-nf">ones</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)]]</span><span class="hljl-t">
  </span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">tmp</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">x</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">x</span><span class="hljl-t"> </span><span class="hljl-oB">\</span><span class="hljl-t"> </span><span class="hljl-p">[</span><span class="hljl-n">x</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-n">I</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">θ</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">tmp</span><span class="hljl-p">[</span><span class="hljl-oB">:</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">tmp</span><span class="hljl-p">[</span><span class="hljl-oB">:</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-ni">4</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">e</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">x</span><span class="hljl-oB">*</span><span class="hljl-n">θ</span><span class="hljl-t">
  </span><span class="hljl-n">se</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">sqrt</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-nf">diag</span><span class="hljl-p">(</span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">e</span><span class="hljl-p">))</span><span class="hljl-oB">./</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">4</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">θ</span><span class="hljl-oB">=</span><span class="hljl-n">θ</span><span class="hljl-p">,</span><span class="hljl-n">se</span><span class="hljl-oB">=</span><span class="hljl-n">se</span><span class="hljl-p">,</span><span class="hljl-n">e</span><span class="hljl-oB">=</span><span class="hljl-n">e</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    b_est_mldivide(y)

  Estimate AR(1) model with intercept and time trend. 

    y[t] = θ[0] + θ[1]t + θ[2]y[t-1] + e[t]

# Arguments    
- `y`: vector 

# Returns
- `θ`: estimated coefficients
- `se`: standard errors
- `e`: residuals 
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">b_est_mldivide</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">x</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">[</span><span class="hljl-nf">ones</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)]]</span><span class="hljl-t">
  </span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">tmp</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">x</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">x</span><span class="hljl-t"> </span><span class="hljl-oB">\</span><span class="hljl-t"> </span><span class="hljl-p">[</span><span class="hljl-n">x</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-n">I</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">θ</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">tmp</span><span class="hljl-p">[</span><span class="hljl-oB">:</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">tmp</span><span class="hljl-p">[</span><span class="hljl-oB">:</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-ni">4</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">e</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">x</span><span class="hljl-oB">*</span><span class="hljl-n">θ</span><span class="hljl-t">
  </span><span class="hljl-n">se</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">sqrt</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-nf">diag</span><span class="hljl-p">(</span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">e</span><span class="hljl-p">))</span><span class="hljl-oB">./</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">4</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">θ</span><span class="hljl-oB">=</span><span class="hljl-n">θ</span><span class="hljl-p">,</span><span class="hljl-n">se</span><span class="hljl-oB">=</span><span class="hljl-n">se</span><span class="hljl-p">,</span><span class="hljl-n">e</span><span class="hljl-oB">=</span><span class="hljl-n">e</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<p>From this, we get a speedup by about a factor of 4 on my computer.</p>
<pre class="hljl">
<span class="hljl-nB">julia&gt; </span><span class="hljl-nd">@btime</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">t</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">gridbootstrap</span><span class="hljl-p">(</span><span class="hljl-nf">wrapper</span><span class="hljl-p">(</span><span class="hljl-n">b_est_mldivide</span><span class="hljl-p">),</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-oB">-&gt;</span><span class="hljl-nf">ar1_original</span><span class="hljl-p">(</span><span class="hljl-n">y0</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">est</span><span class="hljl-oB">.</span><span class="hljl-n">e</span><span class="hljl-p">),</span><span class="hljl-t">
                             </span><span class="hljl-n">αgrid</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">nboot</span><span class="hljl-p">);</span><span class="hljl-t">
  186.256 ms (385673 allocations: 208.60 MiB)</span>
</pre>
<p>Now, the most time consuming parts of the code are, unsurprisingly, the call to <code>\</code>, and, perhaps surprisingly, <code>hcat</code> from creating <code>x</code>. Allocating and copying memory is relatively slow. The creation of <code>x</code> involves both. We can avoid creating <code>x</code> by just accumulating <span class="math inline">\(X&#39;y\)</span> and <span class="math inline">\(X&#39;X\)</span> in a loop.</p>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot; 
    b_est_nox(y)

  Estimate AR(1) model with intercept and time trend. 

    y[t] = θ[0] + θ[1]t + θ[2]y[t-1] + e[t]

# Arguments
- `y`: vector 

# Returns
- `θ`: estimated coefficients
- `se`: standard errors
- `e`: residualas 
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">b_est_nox</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">),</span><span class="hljl-ni">3</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">xy</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">),</span><span class="hljl-ni">3</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-nd">@inbounds</span><span class="hljl-t"> </span><span class="hljl-nd">@simd</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-t">
    </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-oB">*</span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-oB">^</span><span class="hljl-ni">2</span><span class="hljl-t">
    </span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-oB">*</span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t"> 
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-t"> </span><span class="hljl-cs"># = 1&#39;*1</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">T</span><span class="hljl-oB">/</span><span class="hljl-ni">2</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-t"> </span><span class="hljl-cs"># sum(p+1:T)</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-ni">2</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-p">)</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">/</span><span class="hljl-ni">6</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-t"> </span><span class="hljl-cs"># sum((p+1:T).^2)  </span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">tmp</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-t"> </span><span class="hljl-oB">\</span><span class="hljl-t"> </span><span class="hljl-p">[</span><span class="hljl-n">xy</span><span class="hljl-t"> </span><span class="hljl-n">I</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">θ</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">tmp</span><span class="hljl-p">[</span><span class="hljl-oB">:</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">tmp</span><span class="hljl-p">[</span><span class="hljl-oB">:</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-ni">4</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">e</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">similar</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">,</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-nd">@simd</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-t">
    </span><span class="hljl-nd">@inbounds</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">θ</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">θ</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">t</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">θ</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">se</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">sqrt</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-nf">diag</span><span class="hljl-p">(</span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">e</span><span class="hljl-p">))</span><span class="hljl-oB">./</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">4</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">θ</span><span class="hljl-oB">=</span><span class="hljl-n">θ</span><span class="hljl-p">,</span><span class="hljl-n">se</span><span class="hljl-oB">=</span><span class="hljl-n">se</span><span class="hljl-p">,</span><span class="hljl-n">e</span><span class="hljl-oB">=</span><span class="hljl-n">e</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot; 
    b_est_nox(y)

  Estimate AR(1) model with intercept and time trend. 

    y[t] = θ[0] + θ[1]t + θ[2]y[t-1] + e[t]

# Arguments
- `y`: vector 

# Returns
- `θ`: estimated coefficients
- `se`: standard errors
- `e`: residualas 
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">b_est_nox</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">),</span><span class="hljl-ni">3</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">xy</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">),</span><span class="hljl-ni">3</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-nd">@inbounds</span><span class="hljl-t"> </span><span class="hljl-nd">@simd</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-t">
    </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-oB">*</span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-oB">^</span><span class="hljl-ni">2</span><span class="hljl-t">
    </span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-oB">*</span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t"> 
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-t"> </span><span class="hljl-cs"># = 1&#39;*1</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">T</span><span class="hljl-oB">/</span><span class="hljl-ni">2</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-t"> </span><span class="hljl-cs"># sum(p+1:T)</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-ni">2</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-p">)</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">/</span><span class="hljl-ni">6</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-t"> </span><span class="hljl-cs"># sum((p+1:T).^2)  </span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">tmp</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-t"> </span><span class="hljl-oB">\</span><span class="hljl-t"> </span><span class="hljl-p">[</span><span class="hljl-n">xy</span><span class="hljl-t"> </span><span class="hljl-n">I</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">θ</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">tmp</span><span class="hljl-p">[</span><span class="hljl-oB">:</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">tmp</span><span class="hljl-p">[</span><span class="hljl-oB">:</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-ni">4</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-n">e</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">similar</span><span class="hljl-p">(</span><span class="hljl-n">yin</span><span class="hljl-p">,</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-nd">@simd</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-t">
    </span><span class="hljl-nd">@inbounds</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">θ</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">θ</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">t</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">θ</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">yin</span><span class="hljl-p">[</span><span class="hljl-n">t</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">se</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">sqrt</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-nf">diag</span><span class="hljl-p">(</span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">e</span><span class="hljl-p">))</span><span class="hljl-oB">./</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">4</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">θ</span><span class="hljl-oB">=</span><span class="hljl-n">θ</span><span class="hljl-p">,</span><span class="hljl-n">se</span><span class="hljl-oB">=</span><span class="hljl-n">se</span><span class="hljl-p">,</span><span class="hljl-n">e</span><span class="hljl-oB">=</span><span class="hljl-n">e</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<p>We have further cut the time by a factor of two. However, this performance optimization has been costly in terms of readability and extensibility of our code. If we wanted to fit an AR(p) model instead of AR(1), the <code>b_est_nox</code> function would be more difficult to modify than the <code>b_est_mldivide</code> version.</p>
<p>EXERCISE: Read <a href="https://docs.julialang.org/en/v1/manual/performance-tips/">the Performance Tips section of Julia Manual</a> and incorporate some of these tips into the above code.</p>
<p>EXERCISE: write a version of <code>b_est</code> that avoids allocating the full <span class="math inline">\(T \times 3\)</span> <span class="math inline">\(X\)</span> matrix, but can still be generalized to an AR(p) model.</p>
<p>EXERCISE: examine how the relative performance of these versions of <code>b_est</code> vary with <code>T</code>, <code>nboot</code>, and the number of grid points.</p>
<p>EXERCISE: the Julia package <code>StaticArrays.jl</code> provides an alternative array implementation that is often much faster than <code>Base.Array</code>. Try implementing <code>b_est</code> using <code>StaticArrays.jl</code>. You will likely need to use mutable arrays (see <code>@MMatrix</code> and <code>@MVector</code>). Note that <code>inv</code> of a small array will be substantially faster when using <code>StaticArray.jl</code> instead of <code>Base.Array</code>.</p>
<h2 id="fastest-version">Fastest version</h2>
<p>The fastest version of the code that I could write combines the ideas above. As above, it avoids allocating <code>x</code>. It also avoids allocating <code>e</code> by combining the simulation and estimation into a single loop. Finally, it uses mutable static arrays to ensure that operations on <code>xx</code> and <code>xy</code> have as little overhead as possible. Note that for small StaticArrays, <code>inv</code> will call a specialized, fast version, and ends up being faster than <code>\</code>.</p>
<pre class="hljl">
<span class="hljl-k">using</span><span class="hljl-t"> </span><span class="hljl-n">StaticArrays</span>
</pre>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    simulate_estimate_arp(y0, a, e, ar::Val{P}, rindex=T-&gt;rand(1:length(e),T)) 

Simulates and estimates an AR(P) model. `y` is simulated as
  
   y[t] = a*y[t-1] + ϵ[t]
  
and the estimate of θ from 

   y[t] = θ[1] + θ[2]t + θ[3] y[t-1] + ... + θ[P] y[t-P] + u[t] 

is computed. 

# Arguments
- `y0` initial value of y
- `a` AR(1) parameter
- `e` error terms to sample from `ϵ[t] = e[rindex(1)]`
- `ar::Val{P}` order of autoregressive model to estimate
- `rindex` function that returns random index in 1:length(e)

# Returns
- `θ` estimated coefficients
- `se` standard errors
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">simulate_estimate_arp</span><span class="hljl-p">(</span><span class="hljl-n">y0</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">ar</span><span class="hljl-oB">::</span><span class="hljl-nf">Val</span><span class="hljl-p">{</span><span class="hljl-n">P</span><span class="hljl-p">}</span><span class="hljl-oB">=</span><span class="hljl-nf">Val</span><span class="hljl-p">(</span><span class="hljl-ni">1</span><span class="hljl-p">),</span><span class="hljl-t">
                               </span><span class="hljl-n">rindex</span><span class="hljl-oB">=</span><span class="hljl-p">()</span><span class="hljl-oB">-&gt;</span><span class="hljl-nf">rand</span><span class="hljl-p">(</span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">)))</span><span class="hljl-t"> </span><span class="hljl-n">where</span><span class="hljl-t"> </span><span class="hljl-n">P</span><span class="hljl-t">
  </span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">a</span><span class="hljl-p">)</span><span class="hljl-oB">==</span><span class="hljl-n">P</span><span class="hljl-t"> </span><span class="hljl-oB">||</span><span class="hljl-t"> </span><span class="hljl-nf">error</span><span class="hljl-p">(</span><span class="hljl-s">&quot;length(a) not equal to P&quot;</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nd">@MMatrix</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">),</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">xy</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nd">@MVector</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">),</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">yy</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zero</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-n">xt</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nd">@MVector</span><span class="hljl-t"> </span><span class="hljl-nf">ones</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">),</span><span class="hljl-t"> </span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-k">if</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-nf">abs</span><span class="hljl-p">(</span><span class="hljl-n">a</span><span class="hljl-p">)</span><span class="hljl-oB">&lt;</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t">
    </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)]</span><span class="hljl-t"> </span><span class="hljl-oB">.=</span><span class="hljl-t"> </span><span class="hljl-n">y0</span><span class="hljl-t">
  </span><span class="hljl-k">else</span><span class="hljl-t"> 
    </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)]</span><span class="hljl-t"> </span><span class="hljl-oB">.=</span><span class="hljl-t"> </span><span class="hljl-nfB">0.0</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">α</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nd">@MVector</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">),</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-nd">@simd</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-n">P</span><span class="hljl-t">
    </span><span class="hljl-n">α</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-oB">+</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">

  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-n">P</span><span class="hljl-t"> </span><span class="hljl-cs"># = 1&#39;*1</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">T</span><span class="hljl-oB">/</span><span class="hljl-ni">2</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-nf">sum</span><span class="hljl-p">(</span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-n">P</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-cs"># sum(P+1:T)</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-ni">2</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-p">)</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">/</span><span class="hljl-ni">6</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-nf">sum</span><span class="hljl-p">((</span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-n">P</span><span class="hljl-p">)</span><span class="hljl-oB">.^</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-cs"># sum((P+1:T).^2)  </span><span class="hljl-t">
  </span><span class="hljl-nd">@inbounds</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-t">
    </span><span class="hljl-n">et</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">[</span><span class="hljl-nf">rindex</span><span class="hljl-p">()]</span><span class="hljl-t">
    </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
      </span><span class="hljl-nd">@simd</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
        </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">,</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t">
      </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">dot</span><span class="hljl-p">(</span><span class="hljl-n">α</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-oB">+</span><span class="hljl-t"> </span><span class="hljl-n">et</span><span class="hljl-t">
    </span><span class="hljl-nd">@simd</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
      </span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">y</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-n">yy</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">y</span><span class="hljl-oB">^</span><span class="hljl-ni">2</span><span class="hljl-t">
    </span><span class="hljl-k">if</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">&gt;</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t">
      </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">4</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)]</span><span class="hljl-t"> </span><span class="hljl-oB">.=</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)]</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">y</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-nd">@inbounds</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">i</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t">
      </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">,</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">inv</span><span class="hljl-p">(</span><span class="hljl-n">xx</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">θ</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">ixx</span><span class="hljl-oB">*</span><span class="hljl-n">xy</span><span class="hljl-t">
  </span><span class="hljl-n">ee</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">yy</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">xy</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">ixx</span><span class="hljl-oB">*</span><span class="hljl-n">xy</span><span class="hljl-t">
  </span><span class="hljl-n">se</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">sqrt</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-n">abs</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-nf">diag</span><span class="hljl-p">(</span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">ee</span><span class="hljl-p">))</span><span class="hljl-oB">./</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-p">(</span><span class="hljl-ni">2</span><span class="hljl-oB">*</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">))))</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">θ</span><span class="hljl-oB">=</span><span class="hljl-n">θ</span><span class="hljl-p">,</span><span class="hljl-n">se</span><span class="hljl-oB">=</span><span class="hljl-n">se</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    simulate_estimate_arp(y0, a, e, ar::Val{P}, rindex=T-&gt;rand(1:length(e),T)) 

Simulates and estimates an AR(P) model. `y` is simulated as
  
   y[t] = a*y[t-1] + ϵ[t]
  
and the estimate of θ from 

   y[t] = θ[1] + θ[2]t + θ[3] y[t-1] + ... + θ[P] y[t-P] + u[t] 

is computed. 

# Arguments
- `y0` initial value of y
- `a` AR(1) parameter
- `e` error terms to sample from `ϵ[t] = e[rindex(1)]`
- `ar::Val{P}` order of autoregressive model to estimate
- `rindex` function that returns random index in 1:length(e)

# Returns
- `θ` estimated coefficients
- `se` standard errors
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">simulate_estimate_arp</span><span class="hljl-p">(</span><span class="hljl-n">y0</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">ar</span><span class="hljl-oB">::</span><span class="hljl-nf">Val</span><span class="hljl-p">{</span><span class="hljl-n">P</span><span class="hljl-p">}</span><span class="hljl-oB">=</span><span class="hljl-nf">Val</span><span class="hljl-p">(</span><span class="hljl-ni">1</span><span class="hljl-p">),</span><span class="hljl-t">
                               </span><span class="hljl-n">rindex</span><span class="hljl-oB">=</span><span class="hljl-p">()</span><span class="hljl-oB">-&gt;</span><span class="hljl-nf">rand</span><span class="hljl-p">(</span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">)))</span><span class="hljl-t"> </span><span class="hljl-n">where</span><span class="hljl-t"> </span><span class="hljl-n">P</span><span class="hljl-t">
  </span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">a</span><span class="hljl-p">)</span><span class="hljl-oB">==</span><span class="hljl-n">P</span><span class="hljl-t"> </span><span class="hljl-oB">||</span><span class="hljl-t"> </span><span class="hljl-nf">error</span><span class="hljl-p">(</span><span class="hljl-s">&quot;length(a) not equal to P&quot;</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nd">@MMatrix</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">),</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">xy</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nd">@MVector</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">),</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">yy</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zero</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-n">xt</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nd">@MVector</span><span class="hljl-t"> </span><span class="hljl-nf">ones</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">),</span><span class="hljl-t"> </span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-k">if</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-nf">abs</span><span class="hljl-p">(</span><span class="hljl-n">a</span><span class="hljl-p">)</span><span class="hljl-oB">&lt;</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t">
    </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)]</span><span class="hljl-t"> </span><span class="hljl-oB">.=</span><span class="hljl-t"> </span><span class="hljl-n">y0</span><span class="hljl-t">
  </span><span class="hljl-k">else</span><span class="hljl-t"> 
    </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)]</span><span class="hljl-t"> </span><span class="hljl-oB">.=</span><span class="hljl-t"> </span><span class="hljl-nfB">0.0</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">α</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nd">@MVector</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">),</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-nd">@simd</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-n">P</span><span class="hljl-t">
    </span><span class="hljl-n">α</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-oB">+</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">

  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-n">P</span><span class="hljl-t"> </span><span class="hljl-cs"># = 1&#39;*1</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">T</span><span class="hljl-oB">/</span><span class="hljl-ni">2</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-nf">sum</span><span class="hljl-p">(</span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-n">P</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-cs"># sum(P+1:T)</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-ni">2</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-p">)</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">/</span><span class="hljl-ni">6</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-nf">sum</span><span class="hljl-p">((</span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-n">P</span><span class="hljl-p">)</span><span class="hljl-oB">.^</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-cs"># sum((P+1:T).^2)  </span><span class="hljl-t">
  </span><span class="hljl-nd">@inbounds</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-t">
    </span><span class="hljl-n">et</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">[</span><span class="hljl-nf">rindex</span><span class="hljl-p">()]</span><span class="hljl-t">
    </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
      </span><span class="hljl-nd">@simd</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
        </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">,</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t">
      </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">dot</span><span class="hljl-p">(</span><span class="hljl-n">α</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-oB">+</span><span class="hljl-t"> </span><span class="hljl-n">et</span><span class="hljl-t">
    </span><span class="hljl-nd">@simd</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
      </span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">y</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-n">yy</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">y</span><span class="hljl-oB">^</span><span class="hljl-ni">2</span><span class="hljl-t">
    </span><span class="hljl-k">if</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">&gt;</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t">
      </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">4</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)]</span><span class="hljl-t"> </span><span class="hljl-oB">.=</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)]</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">y</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-nd">@inbounds</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">i</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t">
      </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">,</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">inv</span><span class="hljl-p">(</span><span class="hljl-n">xx</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">θ</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">ixx</span><span class="hljl-oB">*</span><span class="hljl-n">xy</span><span class="hljl-t">
  </span><span class="hljl-n">ee</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">yy</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">xy</span><span class="hljl-oB">&#39;*</span><span class="hljl-n">ixx</span><span class="hljl-oB">*</span><span class="hljl-n">xy</span><span class="hljl-t">
  </span><span class="hljl-n">se</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">sqrt</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-n">abs</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-nf">diag</span><span class="hljl-p">(</span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">ee</span><span class="hljl-p">))</span><span class="hljl-oB">./</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-p">(</span><span class="hljl-ni">2</span><span class="hljl-oB">*</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">))))</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">θ</span><span class="hljl-oB">=</span><span class="hljl-n">θ</span><span class="hljl-p">,</span><span class="hljl-n">se</span><span class="hljl-oB">=</span><span class="hljl-n">se</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<p>On my computer, this version of the code is about 15 times faster than the original.</p>
<h1 id="multi-threading">Multi-threading</h1>
<p>Modern computers almost all have multiple cores. We can divide the time it takes our code by up to the number of cores we have (but usually less) by writing multi-threaded code. Multi-threaded code performs multiple tasks at once with shared memory. Before you begin writing multi-threaded code, you should make sure your code isn’t already using all available cores. It is likely that the BLAS and Lapack libraries that Julia uses for linear algebra are multi-threaded. If you code is dominated by large matrix operations, it may already be using all available cores. In that case, there will not be much benefit from additional multi-threading.</p>
<p>Once we have decided that the code might benefit from multi-threading, we should look for loops that can be multi-threaded. There is some small overhead from creating threads and communicating among them. Multi-threading generally works best for loops where each iteration involves substantial work, and each iteration is independent of all others. The loops over grid points and bootstrap repetitions in <code>gridbootstrap</code> are perfect candidates. We don’t care about the order in which these loops get executed. The result of each iteration is (mostly) independent of all others.</p>
<p>Some care must be taken with random number generators and multi-threaded code. See <a href="https://docs.julialang.org/en/v1/manual/parallel-computing/index.html#Side-effects-and-mutable-function-arguments-1">the Julia docs</a> for more information.</p>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    gridbootstrap_threaded(estimator, simulator, 
                    grid::AbstractVector, 
                    nboot=199)
    
Computes grid bootstrap estimates a single parameter model. 

For each α ∈ grid, repeatedly simulate data with parameter α and then compute an estimate. 
 

# Arguments
- `estimator` function of output of `simulator` that returns a
    2-tuple containing an estimate of α and its standard error.  
- `simulator` function that given `α` and `rng`, simulates data
    that can be used to estimate α 
- `grid` grid of parameter values. For each value, `nboot`
    datasets will be simulated and estimates computed.  
- `nboot` 

# Returns
- `ba` hatα - α for each grid value and simulated dataset
- `t` t-stat  for each grid value and simulated dataset
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">gridbootstrap_threaded</span><span class="hljl-p">(</span><span class="hljl-n">estimator</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">simulator</span><span class="hljl-p">,</span><span class="hljl-t">
                                </span><span class="hljl-n">grid</span><span class="hljl-oB">::</span><span class="hljl-n">AbstractVector</span><span class="hljl-p">,</span><span class="hljl-t">
                                </span><span class="hljl-n">nboot</span><span class="hljl-oB">=</span><span class="hljl-ni">199</span><span class="hljl-p">;</span><span class="hljl-t"> </span><span class="hljl-n">rng</span><span class="hljl-oB">=</span><span class="hljl-nf">rngarray</span><span class="hljl-p">(</span><span class="hljl-nf">nthreads</span><span class="hljl-p">()))</span><span class="hljl-t">
  </span><span class="hljl-n">g</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">grid</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">bootq</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">g</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">ba</span><span class="hljl-t">    </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">g</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">bootse</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-n">g</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-nd">@threads</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">ak</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-n">g</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-n">nboot</span><span class="hljl-t"> 
      </span><span class="hljl-p">(</span><span class="hljl-n">bootq</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">],</span><span class="hljl-t"> </span><span class="hljl-n">bootse</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">])</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">estimator</span><span class="hljl-p">(</span><span class="hljl-nf">simulator</span><span class="hljl-p">(</span><span class="hljl-n">grid</span><span class="hljl-p">[</span><span class="hljl-n">ak</span><span class="hljl-p">],</span><span class="hljl-n">rng</span><span class="hljl-p">[</span><span class="hljl-nf">threadid</span><span class="hljl-p">()]))</span><span class="hljl-t">
      </span><span class="hljl-n">ba</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">bootq</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">grid</span><span class="hljl-p">[</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">ts</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">ba</span><span class="hljl-oB">./</span><span class="hljl-n">bootse</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-oB">=</span><span class="hljl-n">ba</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-oB">=</span><span class="hljl-n">ts</span><span class="hljl-p">)</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    rngarray(n)

  Create `n` rng states that will not overlap for 10^20 steps.

  Note: this will be unneeded in Julia 1.3 when thread-safe RNG is
  included.
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">rngarray</span><span class="hljl-p">(</span><span class="hljl-n">n</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">baserng</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t">  </span><span class="hljl-nf">MersenneTwister</span><span class="hljl-p">()</span><span class="hljl-t">
  </span><span class="hljl-n">rng</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">Array</span><span class="hljl-p">{</span><span class="hljl-nf">typeof</span><span class="hljl-p">(</span><span class="hljl-n">baserng</span><span class="hljl-p">)}(</span><span class="hljl-n">undef</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">Base</span><span class="hljl-oB">.</span><span class="hljl-n">Threads</span><span class="hljl-oB">.</span><span class="hljl-nf">nthreads</span><span class="hljl-p">())</span><span class="hljl-t">
  </span><span class="hljl-n">rng</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">baserng</span><span class="hljl-t">
  </span><span class="hljl-n">steps</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">big</span><span class="hljl-p">(</span><span class="hljl-ni">10</span><span class="hljl-p">)</span><span class="hljl-oB">^</span><span class="hljl-ni">20</span><span class="hljl-t"> </span><span class="hljl-cs"># randjump is precomputed for steps = big(10)^20</span><span class="hljl-t">
  </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-nf">nthreads</span><span class="hljl-p">()</span><span class="hljl-t">
    </span><span class="hljl-n">rng</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">Future</span><span class="hljl-oB">.</span><span class="hljl-nf">randjump</span><span class="hljl-p">(</span><span class="hljl-n">rng</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">],</span><span class="hljl-t"> </span><span class="hljl-n">steps</span><span class="hljl-p">)</span><span class="hljl-t"> 
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">rng</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<p>Now, let’s try multi-threading the original version of the code.</p>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    rngarray(n)

  Create `n` rng states that will not overlap for 10^20 steps.

  Note: this will be unneeded in Julia 1.3 when thread-safe RNG is
  included.
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">rngarray</span><span class="hljl-p">(</span><span class="hljl-n">n</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">baserng</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t">  </span><span class="hljl-nf">MersenneTwister</span><span class="hljl-p">()</span><span class="hljl-t">
  </span><span class="hljl-n">rng</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">Array</span><span class="hljl-p">{</span><span class="hljl-nf">typeof</span><span class="hljl-p">(</span><span class="hljl-n">baserng</span><span class="hljl-p">)}(</span><span class="hljl-n">undef</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">Base</span><span class="hljl-oB">.</span><span class="hljl-n">Threads</span><span class="hljl-oB">.</span><span class="hljl-nf">nthreads</span><span class="hljl-p">())</span><span class="hljl-t">
  </span><span class="hljl-n">rng</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">baserng</span><span class="hljl-t">
  </span><span class="hljl-n">steps</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">big</span><span class="hljl-p">(</span><span class="hljl-ni">10</span><span class="hljl-p">)</span><span class="hljl-oB">^</span><span class="hljl-ni">20</span><span class="hljl-t"> </span><span class="hljl-cs"># randjump is precomputed for steps = big(10)^20</span><span class="hljl-t">
  </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">2</span><span class="hljl-oB">:</span><span class="hljl-nf">nthreads</span><span class="hljl-p">()</span><span class="hljl-t">
    </span><span class="hljl-n">rng</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">Future</span><span class="hljl-oB">.</span><span class="hljl-nf">randjump</span><span class="hljl-p">(</span><span class="hljl-n">rng</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">],</span><span class="hljl-t"> </span><span class="hljl-n">steps</span><span class="hljl-p">)</span><span class="hljl-t"> 
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">rng</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<p>The execution times are nearly identical on my computer. The reason is that the computation is dominated by the creation of <code>X</code> and multiplying <code>X&#39;*X</code> and <code>X&#39;*y</code>. These operations are already multi-threaded in the BLAS version I have installed. It is possible first calling <code>using LinearAlgebra; BLAS.set_num_threads(1)</code> would improve the performance of the multi-threaded bootstrap.</p>
<pre class="hljl">
<span class="hljl-k">using</span><span class="hljl-t"> </span><span class="hljl-n">Base</span><span class="hljl-oB">.</span><span class="hljl-n">Threads</span><span class="hljl-t">
</span><span class="hljl-nf">println</span><span class="hljl-p">(</span><span class="hljl-s">&quot;Single thread, original version&quot;</span><span class="hljl-p">)</span>
</pre>
<p>Single thread, original version</p>
<pre class="hljl">
<span class="hljl-nd">@time</span><span class="hljl-t"> </span><span class="hljl-k">begin</span><span class="hljl-t"> </span><span class="hljl-cs"># this is so slow that using btime is not so necessary</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">t</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">gridbootstrap</span><span class="hljl-p">(</span><span class="hljl-nf">wrapper</span><span class="hljl-p">(</span><span class="hljl-n">b_est_original</span><span class="hljl-p">),</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-oB">-&gt;</span><span class="hljl-nf">ar1_original</span><span class="hljl-p">(</span><span class="hljl-n">y0</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">est</span><span class="hljl-oB">.</span><span class="hljl-n">e</span><span class="hljl-p">),</span><span class="hljl-t">
                        </span><span class="hljl-n">αgrid</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-ni">199</span><span class="hljl-p">);</span><span class="hljl-t">
</span><span class="hljl-k">end</span><span class="hljl-p">;</span>
</pre>
<p>4.219345 seconds (428.67 k allocations: 225.041 MiB, 4.09% gc time)</p>
<pre class="hljl">
<span class="hljl-n">rng</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">rngarray</span><span class="hljl-p">(</span><span class="hljl-nf">nthreads</span><span class="hljl-p">())</span><span class="hljl-t">
</span><span class="hljl-cs"># make sure the threaded version is compiled before timing it</span><span class="hljl-t">
</span><span class="hljl-p">(</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">t</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">gridbootstrap_threaded</span><span class="hljl-p">(</span><span class="hljl-nf">wrapper</span><span class="hljl-p">(</span><span class="hljl-n">b_est_original</span><span class="hljl-p">),</span><span class="hljl-t">
                               </span><span class="hljl-p">(</span><span class="hljl-n">a</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">rng</span><span class="hljl-p">)</span><span class="hljl-oB">-&gt;</span><span class="hljl-nf">ar1_original</span><span class="hljl-p">(</span><span class="hljl-n">y0</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">est</span><span class="hljl-oB">.</span><span class="hljl-n">e</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">n</span><span class="hljl-oB">-&gt;</span><span class="hljl-nf">rand</span><span class="hljl-p">(</span><span class="hljl-n">rng</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">),</span><span class="hljl-n">n</span><span class="hljl-p">)),</span><span class="hljl-t">
                               </span><span class="hljl-n">αgrid</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">rng</span><span class="hljl-oB">=</span><span class="hljl-n">rng</span><span class="hljl-p">);</span><span class="hljl-t">
</span><span class="hljl-nf">println</span><span class="hljl-p">(</span><span class="hljl-s">&quot;</span><span class="hljl-si">$</span><span class="hljl-p">(</span><span class="hljl-nf">nthreads</span><span class="hljl-p">())</span><span class="hljl-s"> threads, original version&quot;</span><span class="hljl-p">)</span>
</pre>
<p>30 threads, original version</p>
<pre class="hljl">
<span class="hljl-nd">@time</span><span class="hljl-t"> </span><span class="hljl-k">begin</span><span class="hljl-t"> </span><span class="hljl-cs"># this is so slow that using btime is not so necessary</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">t</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">gridbootstrap_threaded</span><span class="hljl-p">(</span><span class="hljl-nf">wrapper</span><span class="hljl-p">(</span><span class="hljl-n">b_est_original</span><span class="hljl-p">),</span><span class="hljl-t">
                                 </span><span class="hljl-p">(</span><span class="hljl-n">a</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">rng</span><span class="hljl-p">)</span><span class="hljl-oB">-&gt;</span><span class="hljl-nf">ar1_original</span><span class="hljl-p">(</span><span class="hljl-n">y0</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">a</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">est</span><span class="hljl-oB">.</span><span class="hljl-n">e</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">n</span><span class="hljl-oB">-&gt;</span><span class="hljl-nf">rand</span><span class="hljl-p">(</span><span class="hljl-n">rng</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">),</span><span class="hljl-n">n</span><span class="hljl-p">)),</span><span class="hljl-t">
                                 </span><span class="hljl-n">αgrid</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-ni">199</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">rng</span><span class="hljl-oB">=</span><span class="hljl-n">rng</span><span class="hljl-p">);</span><span class="hljl-t">
</span><span class="hljl-k">end</span><span class="hljl-p">;</span>
</pre>
<p>4.266761 seconds (6.56 M allocations: 322.351 MiB, 3.87% gc time)</p>
<p>Notice how the speedup from using multiple threads is far less than number of cores. On my computer, the threaded version of the code is about 4 times faster, even though my computer has 40 “cores” (or 20 physical cores. My computer has 2 processors with 10 cores each, and each core is hyperthreaded into 2. The OS sees 40 processors, but half of them are sharing substantial resources). A speedup far less than the number of cores is typical. Creating and managing multiple threads creates some overhead. Moreover, cores must share various resources; most notably RAM and some cache.</p>
<h1 id="gpu">GPU</h1>
<p>Compared to CPUs, GPUs have a huge number of cores operating at a somewhat slower clockrate. GPUs also have their own separate memory, which they can access faster than CPUs access RAM. These characteristics make GPUs well-suited to large parallel computations. Unfortunately, fully utilizing GPUs can require substantial changes to your code.</p>
<h2 id="array-interface">Array interface</h2>
<p>The easiest way to use a GPU in Julia is through a high level array interface. <code>ArrayFire.jl</code>, <code>CLArrays.jl</code>, and <code>CuArrays.jl</code> each offer such interfaces. We will focus on <code>CuArrays.jl</code> in these notes. <code>CuArrays.jl</code> relies on Nvidia’s CUDA platform, so it only works with Nvidia GPUs. Nvidia tends to dominate GPGPU, and the GPUs available on cedar.computecanada.ca and in my desktop are Nvidia.</p>
<p>Using CuArrays is simple, but has some limitations. You create arrays on the GPU using <code>CuArray</code>. Any array level operation on these will then be performed efficiently on the GPU. This includes broadcast functions with <code>.</code> and matrix multiplies.</p>
<pre class="hljl">
<span class="hljl-k">using</span><span class="hljl-t"> </span><span class="hljl-n">CuArrays</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">Random</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">BenchmarkTools</span><span class="hljl-t">


</span><span class="hljl-n">N</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1000</span><span class="hljl-t">
</span><span class="hljl-n">M</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1000</span><span class="hljl-t">

</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">cuarraydemo</span><span class="hljl-p">(</span><span class="hljl-n">N</span><span class="hljl-p">,</span><span class="hljl-n">M</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-cs"># wrapped in a  function so that the CuArrays are freed</span><span class="hljl-t">
  </span><span class="hljl-cs"># otherwise we will run out GPU memory later</span><span class="hljl-t">
  </span><span class="hljl-n">A</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">randn</span><span class="hljl-p">(</span><span class="hljl-n">N</span><span class="hljl-p">,</span><span class="hljl-n">M</span><span class="hljl-p">);</span><span class="hljl-t">
  </span><span class="hljl-n">b</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">randn</span><span class="hljl-p">(</span><span class="hljl-n">M</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">);</span><span class="hljl-t">
  </span><span class="hljl-nf">println</span><span class="hljl-p">(</span><span class="hljl-s">&quot;Time on CPU&quot;</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">foo</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">,</span><span class="hljl-n">b</span><span class="hljl-p">)</span><span class="hljl-t">
    </span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-oB">.^</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">b</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-nd">@time</span><span class="hljl-t"> </span><span class="hljl-n">c</span><span class="hljl-oB">=</span><span class="hljl-nf">foo</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">,</span><span class="hljl-n">b</span><span class="hljl-p">);</span><span class="hljl-t">
  </span><span class="hljl-nd">@time</span><span class="hljl-t"> </span><span class="hljl-n">c</span><span class="hljl-oB">=</span><span class="hljl-nf">foo</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">,</span><span class="hljl-n">b</span><span class="hljl-p">);</span><span class="hljl-t">
  </span><span class="hljl-n">A_gpu</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">CuArray</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">);</span><span class="hljl-t"> </span><span class="hljl-cs"># copy of A in GPU memory</span><span class="hljl-t">
  </span><span class="hljl-n">b_gpu</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">CuArray</span><span class="hljl-p">(</span><span class="hljl-n">b</span><span class="hljl-p">);</span><span class="hljl-t">
  </span><span class="hljl-nf">println</span><span class="hljl-p">(</span><span class="hljl-s">&quot;Computations on the GPU are fast&quot;</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-cs"># @btime does not work inside a function</span><span class="hljl-t">
  </span><span class="hljl-nd">@time</span><span class="hljl-t"> </span><span class="hljl-n">CuArrays</span><span class="hljl-oB">.</span><span class="hljl-nd">@sync</span><span class="hljl-t"> </span><span class="hljl-n">c_gpu</span><span class="hljl-oB">=</span><span class="hljl-nf">foo</span><span class="hljl-p">(</span><span class="hljl-n">A_gpu</span><span class="hljl-p">,</span><span class="hljl-n">b_gpu</span><span class="hljl-p">);</span><span class="hljl-t">
  </span><span class="hljl-nd">@time</span><span class="hljl-t"> </span><span class="hljl-n">CuArrays</span><span class="hljl-oB">.</span><span class="hljl-nd">@sync</span><span class="hljl-t"> </span><span class="hljl-n">c_gpu</span><span class="hljl-oB">=</span><span class="hljl-nf">foo</span><span class="hljl-p">(</span><span class="hljl-n">A_gpu</span><span class="hljl-p">,</span><span class="hljl-n">b_gpu</span><span class="hljl-p">);</span><span class="hljl-t">
  </span><span class="hljl-nf">println</span><span class="hljl-p">(</span><span class="hljl-s">&quot;But copying to and from GPU memory is not&quot;</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-nf">bar</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">,</span><span class="hljl-n">b</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-nf">Array</span><span class="hljl-p">(</span><span class="hljl-nf">foo</span><span class="hljl-p">(</span><span class="hljl-nf">CuArray</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">),</span><span class="hljl-t"> </span><span class="hljl-nf">CuArray</span><span class="hljl-p">(</span><span class="hljl-n">b</span><span class="hljl-p">)))</span><span class="hljl-t"> 
  </span><span class="hljl-nd">@time</span><span class="hljl-t"> </span><span class="hljl-n">c2</span><span class="hljl-oB">=</span><span class="hljl-nf">bar</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">,</span><span class="hljl-n">b</span><span class="hljl-p">);</span><span class="hljl-t">
  </span><span class="hljl-nd">@time</span><span class="hljl-t"> </span><span class="hljl-n">c2</span><span class="hljl-oB">=</span><span class="hljl-nf">bar</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">,</span><span class="hljl-n">b</span><span class="hljl-p">);</span><span class="hljl-t">  
</span><span class="hljl-k">end</span>
</pre>
<p>cuarraydemo (generic function with 1 method)</p>
<pre class="hljl">
<span class="hljl-nB">julia&gt; </span><span class="hljl-nf">cuarraydemo</span><span class="hljl-p">(</span><span class="hljl-n">N</span><span class="hljl-p">,</span><span class="hljl-n">M</span><span class="hljl-p">);</span><span class="hljl-t">
Time on CPU
  0.001921 seconds (3 allocations: 7.645 MiB)
  0.001942 seconds (3 allocations: 7.645 MiB)
Computations on the GPU are fast
  0.000526 seconds (84 allocations: 3.250 KiB)
  0.000359 seconds (76 allocations: 2.844 KiB)
But copying to and from GPU memory is not
  0.013199 seconds (108 allocations: 15.309 MiB, 61.07% gc time)
  0.004820 seconds (94 allocations: 15.308 MiB)</span>
</pre>
<p><code>CuArrays</code> also allow indexing, so you could use loops and other constructs. However, this will not be fast. <code>CuArrays</code> by itself will be a good method to utilize GPUs when the code is dominated by operations on large arrays.</p>
<p>Unfortunately, the fastest version of our grid bootstrap code does not fit that description. A loop seems needed to generate <span class="math inline">\(y\)</span> due to the recursiveness of the AR(1) model. The fastest version of the code above involves many operations on small 3x3 arrays.</p>
<p>EXERCISE: modify <code>b_est_original</code> or <code>b_est_mldivide</code> to utilize <code>CuArrays</code>. The approach taken in those functions involves some moderate sized matrices, so it may benefit from <code>CuArrays</code>.</p>
<h2 id="cudanative">CUDAnative</h2>
<p>To parallelize the code above on a GPU, we will have to use a lower level interface to the GPU. We will the <code>CUDAnative.jl</code> package. To explain how it works, we will begin with a simple example that just squares all the elements of an array.</p>
<p>Disclaimer: my understanding of CUDA and the inner workings of GPUs is far from complete. Some of the details in this section might be inaccurate.</p>
<p>A typical workflow with CUDAnative consists of</p>
<ol type="1">
<li>Allocate GPU memory and copying arrays into it with <code>CuArray</code>.</li>
<li>Decide how many threads and what configuration of threads to launch.</li>
<li>Each thread does some computation by running a “kernel” function.</li>
<li>Copy result from GPU memory to CPU memory.</li>
</ol>
<p>In the code below, 1 happens in <code>cuarray_cudanative_compare</code>, 2 happens in the <code>square!</code> function, <code>square_kernel!</code> is the kernel in 3, and 4 is just not done.</p>
<h3 id="threads-and-blocks">Threads and blocks</h3>
<p>CUDA organizes GPU threads into blocks. I believe that the threads in a block all execute concurrently. Threads in the same block share some memory and registers. All current Nvidia GPUs have a maximum number of threads per block of 1024. Note that threads in the same block share registers<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, and different kernel functions will use different numbers of registers at once, so depending on the kernel function, you might be limited to fewer than 1024 threads per block. The number of registers available per block depends on your GPU. You can check your GPU characteristics by compiling and running the C++ program in <code>$CUDA_PATH/samples/1_Utilities/deviceQuery/</code>. Alternatively, you can access this information within Julia using <code>CUDAdrv.jl</code>.</p>
<pre class="hljl">
<span class="hljl-k">using</span><span class="hljl-t"> </span><span class="hljl-n">CUDAdrv</span><span class="hljl-t">
</span><span class="hljl-nf">println</span><span class="hljl-p">(</span><span class="hljl-s">&quot;Maximum threads per block </span><span class="hljl-si">$</span><span class="hljl-p">(</span><span class="hljl-nf">attribute</span><span class="hljl-p">(</span><span class="hljl-nf">device</span><span class="hljl-p">(),</span><span class="hljl-t"> </span><span class="hljl-n">CUDAdrv</span><span class="hljl-oB">.</span><span class="hljl-n">MAX_THREADS_PER_BLOCK</span><span class="hljl-p">))</span><span class="hljl-s">&quot;</span><span class="hljl-p">)</span>
</pre>
<p>Maximum threads per block 1024</p>
<pre class="hljl">
<span class="hljl-nf">println</span><span class="hljl-p">(</span><span class="hljl-s">&quot;Maximum x blocks </span><span class="hljl-si">$</span><span class="hljl-p">(</span><span class="hljl-nf">attribute</span><span class="hljl-p">(</span><span class="hljl-nf">device</span><span class="hljl-p">(),</span><span class="hljl-t"> </span><span class="hljl-n">CUDAdrv</span><span class="hljl-oB">.</span><span class="hljl-n">MAX_GRID_DIM_X</span><span class="hljl-p">))</span><span class="hljl-s">&quot;</span><span class="hljl-p">)</span>
</pre>
<p>Maximum x blocks 2147483647</p>
<pre class="hljl">
<span class="hljl-nf">println</span><span class="hljl-p">(</span><span class="hljl-s">&quot;Maximum registers per block </span><span class="hljl-si">$</span><span class="hljl-p">(</span><span class="hljl-nf">attribute</span><span class="hljl-p">(</span><span class="hljl-nf">device</span><span class="hljl-p">(),</span><span class="hljl-t"> </span><span class="hljl-n">CUDAdrv</span><span class="hljl-oB">.</span><span class="hljl-n">MAX_REGISTERS_PER_BLOCK</span><span class="hljl-p">))</span><span class="hljl-s">&quot;</span><span class="hljl-p">)</span>
</pre>
<p>Maximum registers per block 65536</p>
<p>As far as I can tell, there is no simple way to figure out how many registers a kernel function uses. It will depend both on the code you write and how the compiler optimizes the code. If you encounter cryptic error messages about CUDA resources unavailable, then try reducing the number of threads per block.</p>
<p>You can execute more than 1024 threads by specifying a number of blocks. There is also a limit to the number of blocks, but it is rather large. In the code below, we set the number of blocks, so that <code>nblocks*nthreads &gt;= length(A)</code>. Each thread then operates on a single element of <code>A</code>. When the code is executed, each thread has a unique <code>threadIdx</code> and <code>blockIdx</code> combination, and these are used to assign threads to elements of <code>A</code>. The indices go from 1 to number of threads (or blocks). For convenience you can request threads and blocks to have up 3 dimensions, and there are <code>threadIdx().y</code> and <code>threadIdx().z</code> for the additional dimensions.</p>
<pre class="hljl">
<span class="hljl-k">using</span><span class="hljl-t"> </span><span class="hljl-n">CUDAnative</span><span class="hljl-t">

</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">square!</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-oB">::</span><span class="hljl-n">CuArray</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">n</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">maxthreads</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1024</span><span class="hljl-t">
  </span><span class="hljl-n">nthreads</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">min</span><span class="hljl-p">(</span><span class="hljl-n">maxthreads</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">n</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">nblocks</span><span class="hljl-t">  </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">Int</span><span class="hljl-p">(</span><span class="hljl-nf">ceil</span><span class="hljl-p">(</span><span class="hljl-n">n</span><span class="hljl-oB">/</span><span class="hljl-n">nthreads</span><span class="hljl-p">))</span><span class="hljl-t">

  </span><span class="hljl-nd">@cuda</span><span class="hljl-t"> </span><span class="hljl-n">threads</span><span class="hljl-oB">=</span><span class="hljl-n">nthreads</span><span class="hljl-t"> </span><span class="hljl-n">blocks</span><span class="hljl-oB">=</span><span class="hljl-n">nblocks</span><span class="hljl-t"> </span><span class="hljl-nf">square_kernel!</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">)</span><span class="hljl-t">
  
  </span><span class="hljl-k">return</span><span class="hljl-t"> </span><span class="hljl-n">A</span><span class="hljl-t">
</span><span class="hljl-k">end</span><span class="hljl-t">

</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">square_kernel!</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">threadIdx</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">x</span><span class="hljl-t"> </span><span class="hljl-oB">+</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-nf">blockIdx</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">x</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-nf">blockDim</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">x</span><span class="hljl-t">
  </span><span class="hljl-k">if</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">i</span><span class="hljl-oB">&lt;=</span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">))</span><span class="hljl-t">
    </span><span class="hljl-nd">@inbounds</span><span class="hljl-t"> </span><span class="hljl-n">A</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">*=</span><span class="hljl-t"> </span><span class="hljl-n">A</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-k">return</span><span class="hljl-t"> </span><span class="hljl-n">nothing</span><span class="hljl-t"> </span><span class="hljl-cs"># CUDA kernels must return nothing</span><span class="hljl-t">
</span><span class="hljl-k">end</span><span class="hljl-t">

</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">cuarray_cudanative_compare</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">A_gpu</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">CuArray</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">);</span><span class="hljl-t">
  </span><span class="hljl-nf">println</span><span class="hljl-p">(</span><span class="hljl-s">&quot;CUDAnative square!&quot;</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-nd">@time</span><span class="hljl-t"> </span><span class="hljl-n">CuArrays</span><span class="hljl-oB">.</span><span class="hljl-nd">@sync</span><span class="hljl-t"> </span><span class="hljl-nf">square!</span><span class="hljl-p">(</span><span class="hljl-n">A_gpu</span><span class="hljl-p">);</span><span class="hljl-t">
  </span><span class="hljl-nd">@time</span><span class="hljl-t"> </span><span class="hljl-n">CuArrays</span><span class="hljl-oB">.</span><span class="hljl-nd">@sync</span><span class="hljl-t"> </span><span class="hljl-nf">square!</span><span class="hljl-p">(</span><span class="hljl-n">A_gpu</span><span class="hljl-p">);</span><span class="hljl-t">

  </span><span class="hljl-nf">println</span><span class="hljl-p">(</span><span class="hljl-s">&quot;CuArray A*=A&quot;</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">A_gpu</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">CuArray</span><span class="hljl-p">(</span><span class="hljl-n">A</span><span class="hljl-p">);</span><span class="hljl-t">
  </span><span class="hljl-nd">@time</span><span class="hljl-t"> </span><span class="hljl-n">CuArrays</span><span class="hljl-oB">.</span><span class="hljl-nd">@sync</span><span class="hljl-t"> </span><span class="hljl-n">A_gpu</span><span class="hljl-t"> </span><span class="hljl-oB">.*=</span><span class="hljl-t"> </span><span class="hljl-n">A_gpu</span><span class="hljl-p">;</span><span class="hljl-t">
  </span><span class="hljl-nd">@time</span><span class="hljl-t"> </span><span class="hljl-n">CuArrays</span><span class="hljl-oB">.</span><span class="hljl-nd">@sync</span><span class="hljl-t"> </span><span class="hljl-n">A_gpu</span><span class="hljl-t"> </span><span class="hljl-oB">.*=</span><span class="hljl-t"> </span><span class="hljl-n">A_gpu</span><span class="hljl-p">;</span><span class="hljl-t">
  </span><span class="hljl-k">return</span><span class="hljl-t"> </span><span class="hljl-n">nothing</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<p>cuarray_cudanative_compare (generic function with 1 method)</p>
<pre class="hljl">
<span class="hljl-nB">julia&gt; </span><span class="hljl-nf">cuarray_cudanative_compare</span><span class="hljl-p">(</span><span class="hljl-nf">randn</span><span class="hljl-p">(</span><span class="hljl-n">N</span><span class="hljl-p">,</span><span class="hljl-n">M</span><span class="hljl-p">))</span><span class="hljl-t">
CUDAnative square!
  0.061898 seconds (20.21 k allocations: 1.950 MiB)
  0.000173 seconds (21 allocations: 592 bytes)
CuArray A*=A
  0.000328 seconds (59 allocations: 2.953 KiB)
  0.000201 seconds (52 allocations: 2.563 KiB)</span>
</pre>
<h3 id="kernel-limitations">Kernel Limitations</h3>
<p>CUDA kernel functions execute on the GPU and in GPU memory. Since GPU memory is allocated and managed differently than RAM, many Julia functions will not work in CUDA kernels. Most importantly, Julia functions that allocate dynamically sized arrays will not work. This means that even matrix multiplication like <code>θ = ixx*xy</code> will fail (if <code>ixx</code> or <code>xy</code> are dynamically allocated) since it allocates an array for <code>θ</code>. You can, however, have local scalars, tuples, and <code>StaticArrays</code> within a kernel function. The key difference is that the sizes of these types are known at compile time. If <code>ixx</code> and <code>xy</code> are <code>StaticArrays</code>, then you can do something like <code>θ = ixx*xy</code>. Since the compiler knows the size of <code>ixx</code> and <code>xy</code>, the compiler also know the size of <code>θ</code>. However, even with <code>StaticArrays</code> you must be careful with operations that that create new StaticArrays (like matrix multiplies). These will cause problems if called repeatedly within a loop.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>It is possible to dynamicaaly allocate GPU memory within a kernel function, but it requires using the low-level interface to CUDA in <code>CUDAnative.jl</code> and/or <code>CUDAdrv.jl</code>. Moreoever, it is generally not a good idea to be dynamically allocating and freeing memory in each of the thousands of threads you execute.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<h2 id="gpu-grid-bootstrap">GPU grid bootstrap</h2>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    argridbootstrap_gpu(e; αgrid = 0.84:(0.22/20):1.06,
                          nboot=199, RealType = Float32)

Computes grid bootstrap estimates for an AR(1) model. 

For each α ∈ grid, repeatedly simulate data with parameter α and then compute an estimate. 
 
# Arguments
- `e` vector error terms that will be resampled with replacement
        to generate bootstrap sample  
- `grid` grid of parameter values. For each value, `nboot`
        datasets will be simulated and estimates computed.  
- `nboot` 
- `RealType` type of numbers for GPU computation. On many GPUs,
        Float32 will have better performance than Float64.

# Returns
- `ba` hatα - α for each grid value and simulated dataset
- `t` t-stat  for each grid value and simulated dataset   
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">argridbootstrap_gpu</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">y0</span><span class="hljl-p">;</span><span class="hljl-t">
                             </span><span class="hljl-n">grid</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nfB">0.84</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-nfB">0.22</span><span class="hljl-oB">/</span><span class="hljl-ni">20</span><span class="hljl-p">)</span><span class="hljl-oB">:</span><span class="hljl-nfB">1.06</span><span class="hljl-p">,</span><span class="hljl-t">
                             </span><span class="hljl-n">nboot</span><span class="hljl-oB">=</span><span class="hljl-ni">199</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">RealType</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">Float32</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">g</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">grid</span><span class="hljl-p">)</span><span class="hljl-t">

  </span><span class="hljl-n">P</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">3</span><span class="hljl-t">
  </span><span class="hljl-cs"># Allocate GPU memory</span><span class="hljl-t">
  </span><span class="hljl-n">bootq</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">CuArray</span><span class="hljl-p">(</span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-n">RealType</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">g</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-n">ba</span><span class="hljl-t">    </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">CuArray</span><span class="hljl-p">(</span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-n">RealType</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">g</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-n">bootse</span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">CuArray</span><span class="hljl-p">(</span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-n">RealType</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-n">g</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-n">αg</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">CuArray</span><span class="hljl-p">(</span><span class="hljl-n">RealType</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-n">grid</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-n">eg</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">CuArray</span><span class="hljl-p">(</span><span class="hljl-n">RealType</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-n">ei</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">Int</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-n">ceil</span><span class="hljl-oB">.</span><span class="hljl-p">(</span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">)</span><span class="hljl-oB">.*</span><span class="hljl-n">CuArrays</span><span class="hljl-oB">.</span><span class="hljl-nf">rand</span><span class="hljl-p">(</span><span class="hljl-n">RealType</span><span class="hljl-p">,</span><span class="hljl-n">nboot</span><span class="hljl-p">,</span><span class="hljl-n">g</span><span class="hljl-p">,</span><span class="hljl-nf">length</span><span class="hljl-p">(</span><span class="hljl-n">e</span><span class="hljl-p">))))</span><span class="hljl-t">

  </span><span class="hljl-cs"># use of registers in gridkernel! limits the maximum threads to less</span><span class="hljl-t">
  </span><span class="hljl-cs"># than the full 1024</span><span class="hljl-t">
  </span><span class="hljl-n">maxthreads</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">sizeof</span><span class="hljl-p">(</span><span class="hljl-n">RealType</span><span class="hljl-p">)</span><span class="hljl-oB">&lt;=</span><span class="hljl-ni">4</span><span class="hljl-t"> </span><span class="hljl-oB">?</span><span class="hljl-t"> </span><span class="hljl-ni">512</span><span class="hljl-t"> </span><span class="hljl-oB">:</span><span class="hljl-t"> </span><span class="hljl-ni">256</span><span class="hljl-t">
  </span><span class="hljl-n">gthreads</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-ni">2</span><span class="hljl-oB">^</span><span class="hljl-ni">2</span><span class="hljl-t">
  </span><span class="hljl-n">bthreads</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-n">maxthreads</span><span class="hljl-t"> </span><span class="hljl-oB">÷</span><span class="hljl-t"> </span><span class="hljl-n">gthreads</span><span class="hljl-t">
  </span><span class="hljl-n">bblocks</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">Int</span><span class="hljl-p">(</span><span class="hljl-nf">ceil</span><span class="hljl-p">(</span><span class="hljl-n">nboot</span><span class="hljl-oB">/</span><span class="hljl-n">bthreads</span><span class="hljl-p">))</span><span class="hljl-t">
  </span><span class="hljl-n">gblocks</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">Int</span><span class="hljl-p">(</span><span class="hljl-nf">ceil</span><span class="hljl-p">(</span><span class="hljl-n">g</span><span class="hljl-oB">/</span><span class="hljl-n">gthreads</span><span class="hljl-p">))</span><span class="hljl-t">

  </span><span class="hljl-nd">@cuda</span><span class="hljl-t"> </span><span class="hljl-n">threads</span><span class="hljl-oB">=</span><span class="hljl-n">bthreads</span><span class="hljl-p">,</span><span class="hljl-n">gthreads</span><span class="hljl-t"> </span><span class="hljl-n">blocks</span><span class="hljl-oB">=</span><span class="hljl-n">bblocks</span><span class="hljl-p">,</span><span class="hljl-n">gblocks</span><span class="hljl-t"> </span><span class="hljl-nf">argridkernel!</span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-p">,</span><span class="hljl-n">bootq</span><span class="hljl-p">,</span><span class="hljl-n">bootse</span><span class="hljl-p">,</span><span class="hljl-nf">Val</span><span class="hljl-p">(</span><span class="hljl-ni">1</span><span class="hljl-p">),</span><span class="hljl-t"> </span><span class="hljl-n">eg</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">ei</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">αg</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">ts</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">ba</span><span class="hljl-oB">./</span><span class="hljl-n">bootse</span><span class="hljl-t">
  </span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-oB">=</span><span class="hljl-nf">collect</span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-p">),</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-oB">=</span><span class="hljl-nf">collect</span><span class="hljl-p">(</span><span class="hljl-n">ts</span><span class="hljl-p">))</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    argridkernel!(ba,bootq, bootse, ar::Val{P}, e, ei, αgrid) 

GPU kernel for simulation and estimation of AR(P) model. 

# Arguments (modified on return)
- `ba`: `nboot × ngrid` array.  Will be filled with bootstrap estimates of α
   grid values of true α 
- `bootq`: `nboot × ngrid` array.  Will be filled with bootstrap
   estimates of α
- `bootse`: `nboot × ngrid` array.  Will be filled with standard
   errors of α for each bootstrap repetition      


# Arguments (not modified)
- `ar::Val{P}` : autoregressive order for estimation. Simulated
   model will always be AR(1) with 0 intercept and time trend, but
   estimation will use an AR(P) model with intercept and time
   trend. Only the AR(1) parameter estimate is included in `ba`,
   `bootq`, and `bootse`.
- `e` : error terms to draw with replacement
- `ei` : `nboot × ngrid × length(e)` array of indices of `e` to
         use to generate bootstrap sample1
- `αgrid` : length `ngrid` values of AR(1) parameter to perform
   bootstrap on.

Returns nothing, but modifies in place `ba`, `bootq`, and `bootse`
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">argridkernel!</span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-p">,</span><span class="hljl-n">bootq</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">bootse</span><span class="hljl-p">,</span><span class="hljl-t"> 
                       </span><span class="hljl-n">ar</span><span class="hljl-oB">::</span><span class="hljl-nf">Val</span><span class="hljl-p">{</span><span class="hljl-n">P</span><span class="hljl-p">},</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">ei</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">αgrid</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-n">where</span><span class="hljl-t"> </span><span class="hljl-n">P</span><span class="hljl-t">
  </span><span class="hljl-n">b</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">threadIdx</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">x</span><span class="hljl-t"> </span><span class="hljl-oB">+</span><span class="hljl-t">  </span><span class="hljl-p">(</span><span class="hljl-nf">blockIdx</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">x</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-nf">blockDim</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">x</span><span class="hljl-t">  
  </span><span class="hljl-n">ak</span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">threadIdx</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">+</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-nf">blockIdx</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">y</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-nf">blockDim</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">y</span><span class="hljl-t">  
  </span><span class="hljl-k">if</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">b</span><span class="hljl-oB">&gt;</span><span class="hljl-nf">size</span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-oB">||</span><span class="hljl-t"> </span><span class="hljl-n">ak</span><span class="hljl-oB">&gt;</span><span class="hljl-nf">size</span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">))</span><span class="hljl-t">
    </span><span class="hljl-k">return</span><span class="hljl-t"> </span><span class="hljl-n">nothing</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">size</span><span class="hljl-p">(</span><span class="hljl-n">ei</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">R</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">MMatrix</span><span class="hljl-p">{</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-n">R</span><span class="hljl-p">})</span><span class="hljl-t">
  </span><span class="hljl-n">xy</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">MVector</span><span class="hljl-p">{</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-n">R</span><span class="hljl-p">})</span><span class="hljl-t">
  </span><span class="hljl-n">xt</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">MVector</span><span class="hljl-p">{</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-n">R</span><span class="hljl-p">})</span><span class="hljl-t">
  </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">one</span><span class="hljl-p">(</span><span class="hljl-n">R</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">yy</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zero</span><span class="hljl-p">(</span><span class="hljl-n">R</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-n">P</span><span class="hljl-t"> 
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">T</span><span class="hljl-oB">/</span><span class="hljl-ni">2</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">P</span><span class="hljl-oB">/</span><span class="hljl-ni">2</span><span class="hljl-t"> </span><span class="hljl-cs">#sum((P+1):T) </span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-ni">2</span><span class="hljl-oB">*</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">T</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">/</span><span class="hljl-ni">6</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-ni">2</span><span class="hljl-oB">*</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">P</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">/</span><span class="hljl-ni">6</span><span class="hljl-t"> </span><span class="hljl-cs">#sum((P+1:T).^2)</span><span class="hljl-t">
  </span><span class="hljl-n">α</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">MVector</span><span class="hljl-p">{</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">R</span><span class="hljl-p">})</span><span class="hljl-t">
  </span><span class="hljl-n">α</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">αgrid</span><span class="hljl-p">[</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-nd">@inbounds</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-t">
    </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
      </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
        </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">,</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t">
      </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">[</span><span class="hljl-n">ei</span><span class="hljl-p">[</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">,</span><span class="hljl-n">t</span><span class="hljl-p">]]</span><span class="hljl-t"> </span><span class="hljl-oB">+</span><span class="hljl-t"> </span><span class="hljl-nf">dot</span><span class="hljl-p">(</span><span class="hljl-n">α</span><span class="hljl-p">,</span><span class="hljl-n">xt</span><span class="hljl-p">)</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
      </span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">y</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-n">yy</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">y</span><span class="hljl-oB">*</span><span class="hljl-n">y</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">4</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-cs"># shift y lags</span><span class="hljl-t">
      </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">y</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  
  </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
     </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">i</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t">
       </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">,</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t">
     </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">inv</span><span class="hljl-p">(</span><span class="hljl-n">xx</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">θ3</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zero</span><span class="hljl-p">(</span><span class="hljl-n">R</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-ni">3</span><span class="hljl-t">
    </span><span class="hljl-n">θ3</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">ixx</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">,</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">ee</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">yy</span><span class="hljl-t">
  </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-ni">3</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-ni">3</span><span class="hljl-t">
      </span><span class="hljl-n">ee</span><span class="hljl-t"> </span><span class="hljl-oB">-=</span><span class="hljl-t"> </span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">ixx</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">,</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">se3</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">CUDAnative</span><span class="hljl-oB">.</span><span class="hljl-nf">sqrt</span><span class="hljl-p">(</span><span class="hljl-n">ixx</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">ee</span><span class="hljl-oB">/</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-p">(</span><span class="hljl-ni">2</span><span class="hljl-oB">*</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)))</span><span class="hljl-t">
  </span><span class="hljl-n">bootq</span><span class="hljl-p">[</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t">  </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">θ3</span><span class="hljl-t">
  </span><span class="hljl-n">bootse</span><span class="hljl-p">[</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">se3</span><span class="hljl-t">
  </span><span class="hljl-n">ba</span><span class="hljl-p">[</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">bootq</span><span class="hljl-p">[</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">αgrid</span><span class="hljl-p">[</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-k">return</span><span class="hljl-t"> </span><span class="hljl-n">nothing</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<pre class="hljl">
<span class="hljl-s">&quot;&quot;&quot;
    argridkernel!(ba,bootq, bootse, ar::Val{P}, e, ei, αgrid) 

GPU kernel for simulation and estimation of AR(P) model. 

# Arguments (modified on return)
- `ba`: `nboot × ngrid` array.  Will be filled with bootstrap estimates of α
   grid values of true α 
- `bootq`: `nboot × ngrid` array.  Will be filled with bootstrap
   estimates of α
- `bootse`: `nboot × ngrid` array.  Will be filled with standard
   errors of α for each bootstrap repetition      


# Arguments (not modified)
- `ar::Val{P}` : autoregressive order for estimation. Simulated
   model will always be AR(1) with 0 intercept and time trend, but
   estimation will use an AR(P) model with intercept and time
   trend. Only the AR(1) parameter estimate is included in `ba`,
   `bootq`, and `bootse`.
- `e` : error terms to draw with replacement
- `ei` : `nboot × ngrid × length(e)` array of indices of `e` to
         use to generate bootstrap sample1
- `αgrid` : length `ngrid` values of AR(1) parameter to perform
   bootstrap on.

Returns nothing, but modifies in place `ba`, `bootq`, and `bootse`
&quot;&quot;&quot;</span><span class="hljl-t">
</span><span class="hljl-k">function</span><span class="hljl-t"> </span><span class="hljl-nf">argridkernel!</span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-p">,</span><span class="hljl-n">bootq</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">bootse</span><span class="hljl-p">,</span><span class="hljl-t"> 
                       </span><span class="hljl-n">ar</span><span class="hljl-oB">::</span><span class="hljl-nf">Val</span><span class="hljl-p">{</span><span class="hljl-n">P</span><span class="hljl-p">},</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">ei</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">αgrid</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-n">where</span><span class="hljl-t"> </span><span class="hljl-n">P</span><span class="hljl-t">
  </span><span class="hljl-n">b</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">threadIdx</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">x</span><span class="hljl-t"> </span><span class="hljl-oB">+</span><span class="hljl-t">  </span><span class="hljl-p">(</span><span class="hljl-nf">blockIdx</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">x</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-nf">blockDim</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">x</span><span class="hljl-t">  
  </span><span class="hljl-n">ak</span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">threadIdx</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">+</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-nf">blockIdx</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">y</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-nf">blockDim</span><span class="hljl-p">()</span><span class="hljl-oB">.</span><span class="hljl-n">y</span><span class="hljl-t">  
  </span><span class="hljl-k">if</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">b</span><span class="hljl-oB">&gt;</span><span class="hljl-nf">size</span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-oB">||</span><span class="hljl-t"> </span><span class="hljl-n">ak</span><span class="hljl-oB">&gt;</span><span class="hljl-nf">size</span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">))</span><span class="hljl-t">
    </span><span class="hljl-k">return</span><span class="hljl-t"> </span><span class="hljl-n">nothing</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">T</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">size</span><span class="hljl-p">(</span><span class="hljl-n">ei</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">R</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">eltype</span><span class="hljl-p">(</span><span class="hljl-n">ba</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">MMatrix</span><span class="hljl-p">{</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-n">R</span><span class="hljl-p">})</span><span class="hljl-t">
  </span><span class="hljl-n">xy</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">MVector</span><span class="hljl-p">{</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-n">R</span><span class="hljl-p">})</span><span class="hljl-t">
  </span><span class="hljl-n">xt</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">MVector</span><span class="hljl-p">{</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-n">R</span><span class="hljl-p">})</span><span class="hljl-t">
  </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">one</span><span class="hljl-p">(</span><span class="hljl-n">R</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">yy</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zero</span><span class="hljl-p">(</span><span class="hljl-n">R</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-n">P</span><span class="hljl-t"> 
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">1</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">T</span><span class="hljl-oB">/</span><span class="hljl-ni">2</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">P</span><span class="hljl-oB">/</span><span class="hljl-ni">2</span><span class="hljl-t"> </span><span class="hljl-cs">#sum((P+1):T) </span><span class="hljl-t">
  </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-ni">2</span><span class="hljl-oB">*</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">T</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">/</span><span class="hljl-ni">6</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-ni">2</span><span class="hljl-oB">*</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">*</span><span class="hljl-n">P</span><span class="hljl-oB">*</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">/</span><span class="hljl-ni">6</span><span class="hljl-t"> </span><span class="hljl-cs">#sum((P+1:T).^2)</span><span class="hljl-t">
  </span><span class="hljl-n">α</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zeros</span><span class="hljl-p">(</span><span class="hljl-nf">MVector</span><span class="hljl-p">{</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">,</span><span class="hljl-t"> </span><span class="hljl-n">R</span><span class="hljl-p">})</span><span class="hljl-t">
  </span><span class="hljl-n">α</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">αgrid</span><span class="hljl-p">[</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-nd">@inbounds</span><span class="hljl-t"> </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-oB">:</span><span class="hljl-n">T</span><span class="hljl-t">
    </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">2</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">t</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
      </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
        </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">,</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t">
      </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-n">y</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">e</span><span class="hljl-p">[</span><span class="hljl-n">ei</span><span class="hljl-p">[</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">,</span><span class="hljl-n">t</span><span class="hljl-p">]]</span><span class="hljl-t"> </span><span class="hljl-oB">+</span><span class="hljl-t"> </span><span class="hljl-nf">dot</span><span class="hljl-p">(</span><span class="hljl-n">α</span><span class="hljl-p">,</span><span class="hljl-n">xt</span><span class="hljl-p">)</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-kp">in</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
      </span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">y</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-n">yy</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">y</span><span class="hljl-oB">*</span><span class="hljl-n">y</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">4</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t"> </span><span class="hljl-cs"># shift y lags</span><span class="hljl-t">
      </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
    </span><span class="hljl-n">xt</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">y</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  
  </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">3</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)</span><span class="hljl-t">
     </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-p">(</span><span class="hljl-n">i</span><span class="hljl-oB">-</span><span class="hljl-ni">1</span><span class="hljl-p">)</span><span class="hljl-t">
       </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">,</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">xx</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">,</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t">
     </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">ixx</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">inv</span><span class="hljl-p">(</span><span class="hljl-n">xx</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-n">θ3</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-nf">zero</span><span class="hljl-p">(</span><span class="hljl-n">R</span><span class="hljl-p">)</span><span class="hljl-t">
  </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-ni">3</span><span class="hljl-t">
    </span><span class="hljl-n">θ3</span><span class="hljl-t"> </span><span class="hljl-oB">+=</span><span class="hljl-t"> </span><span class="hljl-n">ixx</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">,</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">ee</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">yy</span><span class="hljl-t">
  </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">i</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-ni">3</span><span class="hljl-t">
    </span><span class="hljl-k">for</span><span class="hljl-t"> </span><span class="hljl-n">j</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-ni">1</span><span class="hljl-oB">:</span><span class="hljl-ni">3</span><span class="hljl-t">
      </span><span class="hljl-n">ee</span><span class="hljl-t"> </span><span class="hljl-oB">-=</span><span class="hljl-t"> </span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">ixx</span><span class="hljl-p">[</span><span class="hljl-n">i</span><span class="hljl-p">,</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">xy</span><span class="hljl-p">[</span><span class="hljl-n">j</span><span class="hljl-p">]</span><span class="hljl-t">
    </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-k">end</span><span class="hljl-t">
  </span><span class="hljl-n">se3</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">CUDAnative</span><span class="hljl-oB">.</span><span class="hljl-nf">sqrt</span><span class="hljl-p">(</span><span class="hljl-n">ixx</span><span class="hljl-p">[</span><span class="hljl-ni">3</span><span class="hljl-p">,</span><span class="hljl-ni">3</span><span class="hljl-p">]</span><span class="hljl-oB">*</span><span class="hljl-n">ee</span><span class="hljl-oB">/</span><span class="hljl-p">(</span><span class="hljl-n">T</span><span class="hljl-oB">-</span><span class="hljl-p">(</span><span class="hljl-ni">2</span><span class="hljl-oB">*</span><span class="hljl-n">P</span><span class="hljl-oB">+</span><span class="hljl-ni">2</span><span class="hljl-p">)))</span><span class="hljl-t">
  </span><span class="hljl-n">bootq</span><span class="hljl-p">[</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t">  </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">θ3</span><span class="hljl-t">
  </span><span class="hljl-n">bootse</span><span class="hljl-p">[</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">se3</span><span class="hljl-t">
  </span><span class="hljl-n">ba</span><span class="hljl-p">[</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">=</span><span class="hljl-t"> </span><span class="hljl-n">bootq</span><span class="hljl-p">[</span><span class="hljl-n">b</span><span class="hljl-p">,</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t"> </span><span class="hljl-oB">-</span><span class="hljl-t"> </span><span class="hljl-n">αgrid</span><span class="hljl-p">[</span><span class="hljl-n">ak</span><span class="hljl-p">]</span><span class="hljl-t">
  </span><span class="hljl-k">return</span><span class="hljl-t"> </span><span class="hljl-n">nothing</span><span class="hljl-t">
</span><span class="hljl-k">end</span>
</pre>
<p>Compared to the fastest CPU code above, the GPU version takes about 1/20th the time of the single-threaded CPU code, and about 1/5th the time of the 30-threaded CPU code. Considering that the two CPUs in my workstation together cost about 6 times more than the single GPU, the performance of the GPU code is quite good. Also, we carefully profiled and tuned the CPU code, but not the GPU code (although the GPU code does use all algorithmic improvements of the fastest CPU code). Profiling GPU kernel code requires using Nvidia’s profiler, see <a href="https://juliagpu.github.io/CUDAnative.jl/stable/man/performance.html">CUDAnative documentation</a> for information.</p>
<div id="refs" class="references" role="doc-bibliography">
<div id="ref-hansen99">
<p>Hansen, Bruce E. 1999. “The Grid Bootstrap and the Autoregressive Model.” <em>The Review of Economics and Statistics</em> 81 (4): 594–607. <a href="https://doi.org/10.1162/003465399558463">https://doi.org/10.1162/003465399558463</a>.</p>
</div>
</div>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>Processor registers are the fastest bits of memory on the processor, and registers are where the actual addition, multiplication, and other instructions are carried out.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>If you create StaticArrays inside a loop, they get allocated to the GPU’s “dynamic shared memory.” I believe a new allocation happens each loop iteration. This will be slow, and there is a fairly small amount of dynamic shared memory, of which you will soon run out.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>There are situations where allocating shared memory is a needed and a good idea, but these require some advanced techniques that we will not cover.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

<HR />
<div class="footer"><p>
Published from <a href="argridboot.jmd">argridboot.jmd</a> using
<a href="http://github.com/mpastell/Weave.jl">Weave.jl</a>  on 2019-10-13.
<p></div>

    </div>
  </div>
</div>
</body>
</html>
